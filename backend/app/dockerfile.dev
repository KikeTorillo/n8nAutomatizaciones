# =========================================
# Dockerfile para Backend API + Express
# Modo: Desarrollo con Nodemon hot reload
# =========================================

FROM node:22-alpine

# Establecer directorio de trabajo (consistente con frontend)
WORKDIR /app

# ========================================
# DEPENDENCIAS DEL SISTEMA
# ========================================
# vips-dev: Requerido para Sharp (procesamiento de imágenes)
# build-base: Compiladores para módulos nativos
# python3: Requerido por algunos módulos npm
RUN apk add --no-cache \
    vips-dev \
    build-base \
    python3

# Crear usuario no-root para seguridad
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nodejs -u 1001

# Copiar archivos de dependencias (como nodejs para caching)
COPY --chown=nodejs:nodejs package*.json ./

# Instalar dependencias (incluyendo devDependencies para desarrollo)
RUN npm install

# Instalar nodemon globalmente
RUN npm install -g nodemon

# Cambiar al usuario no-root
USER nodejs

# No copiamos código aquí porque lo montaremos como volumen
# Esto permite hot reload cuando cambien los archivos

# Exponer puerto de Express
EXPOSE 3000

# Comando para iniciar servidor en modo desarrollo
# Nodemon escucha cambios en todo el proyecto
CMD ["nodemon", "--watch", ".", "app.js"]
