{
  "name": "My workflow",
  "nodes": [
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "20a0b009-eb9b-44fc-bda9-4dffd8085f04",
              "name": "sender",
              "value": "={{ $json.body.data.key.remoteJid }}",
              "type": "string"
            },
            {
              "id": "2763de37-d1d4-4564-9980-eeb091c9afd6",
              "name": "messageType",
              "value": "={{ $json.body.data.messageType }}",
              "type": "string"
            },
            {
              "id": "6076cf73-bc7d-41d6-b053-c09611925c31",
              "name": "conversation",
              "value": "={{ $json.body.data.message.conversation }}",
              "type": "string"
            },
            {
              "id": "f7e32389-50f8-4633-913c-6f233ff7656e",
              "name": "sessionId",
              "value": "={{ $json.body.data.key.id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        224,
        0
      ],
      "id": "53976454-e738-459a-b2c9-2645051f75fe",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=http://evolution_api:8080/message/sendText/{{ $('Webhook1').item.json.body.instance }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "apikey",
              "value": "TuClaveAPIEvolution123!"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('Edit Fields').item.json.sender.split('@')[0] }}"
            },
            {
              "name": "text",
              "value": "={{ $json.output }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        912,
        0
      ],
      "id": "7dfbe674-9dc4-4e6c-97d7-9d7d1f32213f",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.conversation }}",
        "options": {
          "systemMessage": "=Eres un asistente llamado JARVIS que interpreta mensajes recibidos por WhatsApp para gestionar citas en Google Calendar.\n\nHoy es {{ $now }}. Zona horaria: America/Mexico City\n\nTu trabajo es entender lo que el usuario necesita y actuar en consecuencia, usando las herramientas disponibles. Solo gestionas citas. No respondes preguntas generales.\n\nPuedes realizar las siguientes tareas:\n- crear_evento: cuando el usuario quiere agendar una cita nueva\n- reprogramar_evento: cuando quiere cambiar la fecha o la hora de una cita existente\n- eliminar_evento: cuando quiere cancelar una cita existente\n- consultar_evento: cuando quiere saber cu√°ndo tiene una cita\n\nEjemplos de mensajes y sus intenciones:\n- ‚ÄúAgenda una reuni√≥n con Laura ma√±ana a las 4‚Äù = crear_evento\n- ‚ÄúPasemos la cita del lunes para el mi√©rcoles‚Äù = reprogramar_evento\n- ‚ÄúCancela la reuni√≥n de hoy‚Äù = eliminar_evento\n- ‚Äú¬øQu√© tengo esta semana?‚Äù = consultar_evento\n\nHerramientas disponibles seg√∫n la tarea:\n- crear_evento = agendar cita\n- reprogramar_evento = reprogramar cita\n- eliminar_evento = cancelar cita\n- consultar_evento = consultar citas\n\nTu respuesta debe ser en lenguaje natural, clara y breve, como si estuvieras escribiendo por WhatsApp. Usa emojis si es apropiado.\n\nExtrae toda la informaci√≥n posible del mensaje: t√≠tulo, fecha, hora, duraci√≥n y ubicaci√≥n. Si alg√∫n dato importante no est√° claro (por ejemplo, la hora), preg√∫ntalo de forma amable antes de ejecutar la acci√≥n.\n\nEjemplos de respuesta:\n- Evento creado: ‚ÄúListo, agend√© tu cita ‚ÄòReuni√≥n con Laura‚Äô para ma√±ana a las 4:00 p.m. üòä‚Äù\n- Evento reprogramado: ‚ÄúHe actualizado tu cita. Ahora es el mi√©rcoles a las 3:00 p.m.‚Äù\n- Evento eliminado: ‚ÄúHe cancelado tu cita programada para hoy. Si necesitas otra, dime. üëç‚Äù\n- Consulta: ‚ÄúTienes una cita ‚ÄòReuni√≥n con equipo‚Äô el viernes a las 10:00 a.m.‚Äù\n\nSi el mensaje es ambiguo o no se entiende qu√© desea el usuario, p√≠dele amablemente que aclare su intenci√≥n.\n\nNo devuelvas estructuras t√©cnicas ni generes JSON. Tu √∫nica salida debe ser una respuesta conversacional humana.\n\nPuedes usar la memoria de los √∫ltimos 10 mensajes del usuario para mantener el contexto si es necesario.\n\nTen en cuenta estas expresiones comunes de fecha y su interpretaci√≥n:\n- ‚Äúma√±ana a las 10am‚Äù = d√≠a siguiente a la fecha actual, a las 10:00 a.m.\n- ‚Äúel pr√≥ximo lunes‚Äù = el lunes siguiente a la fecha actual\n- ‚Äúdentro de 8 d√≠as‚Äù = ocho d√≠as despu√©s de la fecha actual\n- ‚Äúel mes que viene‚Äù = el mismo d√≠a del mes siguiente\n- ‚Äúeste viernes por la tarde‚Äù = si el viernes ya pas√≥ esta semana, se refiere al pr√≥ximo viernes\n\nSi no se menciona una duraci√≥n espec√≠fica para la cita, asume que es de una hora.\n\nCuando uses una herramienta, aseg√∫rate de proporcionar correctamente estos datos si est√°n disponibles en el mensaje del usuario:\n- T√≠tulo del evento = summary\n- Fecha y hora de inicio = startTime (formato ISO 8601)\n- Fecha y hora de finalizaci√≥n = endTime (puede calcularse si hay duraci√≥n)\n- Descripci√≥n = description (opcional)\n- Ubicaci√≥n = location (opcional)\n\nNo incluyas enlaces de videollamadas (como Google Meet) en tus respuestas, aunque la herramienta los devuelva."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        512,
        0
      ],
      "id": "fd6fa0d8-9d83-496b-9f2a-5777bc123e43",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatDeepSeek",
      "typeVersion": 1,
      "position": [
        448,
        224
      ],
      "id": "fcf4653f-aea5-4a89-a4d3-80c656391be7",
      "name": "DeepSeek Chat Model",
      "credentials": {
        "deepSeekApi": {
          "id": "GymfDTasPtbxvf5L",
          "name": "DeepSeek account"
        }
      }
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        576,
        224
      ],
      "id": "1554e2dd-6b54-4eea-8a15-eba47d5d885b",
      "name": "Postgres Chat Memory",
      "credentials": {
        "postgres": {
          "id": "TW1CP56n2LM4Zr9n",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "calendar": {
          "__rl": true,
          "value": "arellanestorillo@gmail.com",
          "mode": "list",
          "cachedResultName": "arellanestorillo@gmail.com"
        },
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        704,
        224
      ],
      "id": "0e89adb6-4d94-451c-9f0c-0a6670901d7b",
      "name": "agenda_cita",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "KHd3eAzrQa2xotci",
          "name": "Google Calendar account"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "5bc80ec5-b2db-40fe-92b3-67697c82d03a",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        0,
        0
      ],
      "id": "56b5cf48-5ce2-4c47-9927-65aeae3726b9",
      "name": "Webhook1",
      "webhookId": "5bc80ec5-b2db-40fe-92b3-67697c82d03a"
    }
  ],
  "pinData": {},
  "connections": {
    "Edit Fields": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DeepSeek Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "agenda_cita": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook1": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "f529fe62-2204-4f0a-8910-02683010c672",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "688fad0558662f97a21884a00394fdf4a4298d3e4a6d4a38e695cdaeda48947e"
  },
  "id": "KqLIDy5X9LT0OfcV",
  "tags": []
}