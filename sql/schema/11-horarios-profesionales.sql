-- ====================================================================
-- üïí TABLA HORARIOS PROFESIONALES - PLANTILLAS DE TRABAJO BASE
-- ====================================================================
--
-- Esta tabla define los horarios base/plantilla de trabajo de cada profesional
-- que sirven para generar autom√°ticamente los slots de disponibilidad.
--
-- üéØ DIFERENCIA CLAVE CON horarios_disponibilidad:
-- ‚Ä¢ horarios_profesionales = Plantillas/horarios base (ej: "Lunes 9-18")
-- ‚Ä¢ horarios_disponibilidad = Slots espec√≠ficos generados (ej: "2024-01-15 9:30-10:00")
--
-- üìä CASOS DE USO:
-- ‚Ä¢ Horarios regulares de trabajo
-- ‚Ä¢ Breaks y tiempos de almuerzo
-- ‚Ä¢ Horarios premium con recargo
-- ‚Ä¢ Configuraci√≥n de duraciones de slot personalizadas
-- ‚Ä¢ Vigencia temporal (vacaciones, cambios estacionales)
--
-- üîÑ ORDEN DE EJECUCI√ìN: #11 (Despu√©s de subscriptions)
-- üîí SEGURIDAD: RLS habilitado para aislamiento multi-tenant
-- ====================================================================

-- ====================================================================
-- üïí TABLA HORARIOS_PROFESIONALES - PLANTILLAS DE HORARIOS BASE
-- ====================================================================
-- Define los horarios de trabajo base de cada profesional que servir√°n
-- para generar autom√°ticamente los slots de disponibilidad espec√≠ficos.
--
-- üîß CARACTER√çSTICAS AVANZADAS:
-- ‚Ä¢ M√∫ltiples horarios por d√≠a (ma√±ana/tarde con break)
-- ‚Ä¢ Tipos de horario (regular, break, almuerzo, premium)
-- ‚Ä¢ Vigencia temporal para cambios estacionales
-- ‚Ä¢ Configuraci√≥n de slots y precios personalizables
-- ‚Ä¢ Validaciones exhaustivas de coherencia temporal
-- ====================================================================

CREATE TABLE horarios_profesionales (
    -- üîë IDENTIFICACI√ìN Y RELACIONES
    id SERIAL PRIMARY KEY,
    organizacion_id INTEGER NOT NULL REFERENCES organizaciones(id) ON DELETE CASCADE,
    profesional_id INTEGER NOT NULL REFERENCES profesionales(id) ON DELETE CASCADE,

    -- ====================================================================
    -- üìÖ SECCI√ìN: CONFIGURACI√ìN TEMPORAL BASE
    -- ====================================================================
    dia_semana INTEGER NOT NULL CHECK (dia_semana >= 0 AND dia_semana <= 6), -- 0=domingo, 6=s√°bado
    hora_inicio TIME NOT NULL,
    hora_fin TIME NOT NULL,
    zona_horaria VARCHAR(50) DEFAULT 'America/Mexico_City',

    -- ====================================================================
    -- üéØ SECCI√ìN: TIPO Y CONFIGURACI√ìN DE HORARIO
    -- ====================================================================
    tipo_horario VARCHAR(20) NOT NULL DEFAULT 'regular', -- 'regular', 'break', 'almuerzo', 'premium'
    nombre_horario VARCHAR(50),                          -- Ej: "Horario Matutino", "Break Almuerzo"
    descripcion TEXT,                                    -- Descripci√≥n del horario

    -- ====================================================================
    -- ‚öôÔ∏è SECCI√ìN: CONFIGURACI√ìN OPERATIVA
    -- ====================================================================
    permite_citas BOOLEAN NOT NULL DEFAULT TRUE,        -- FALSE para breaks/almuerzos

    -- ====================================================================
    -- üí∞ SECCI√ìN: CONFIGURACI√ìN COMERCIAL
    -- ====================================================================
    precio_premium DECIMAL(5,2) DEFAULT 0.00,           -- Recargo por horario premium
    permite_descuentos BOOLEAN DEFAULT TRUE,             -- Si aplican descuentos promocionales

    -- ====================================================================
    -- üìÖ SECCI√ìN: VIGENCIA TEMPORAL (OPCIONAL)
    -- ====================================================================
    fecha_inicio DATE DEFAULT CURRENT_DATE,             -- Desde cu√°ndo aplica este horario
    fecha_fin DATE,                                     -- Hasta cu√°ndo (NULL = indefinido)
    motivo_vigencia TEXT,                               -- Ej: "Horario de invierno", "Vacaciones"

    -- ====================================================================
    -- ‚öôÔ∏è SECCI√ìN: CONFIGURACI√ìN AVANZADA
    -- ====================================================================
    capacidad_maxima INTEGER DEFAULT 1,                 -- Para servicios grupales
    configuracion_especial JSONB DEFAULT '{}',          -- Configuraciones adicionales flexibles
                                                        -- Ej: {"solo_servicios": ["corte_premium"], "requiere_confirmacion": true}

    -- ====================================================================
    -- üéõÔ∏è SECCI√ìN: CONTROL Y ESTADO
    -- ====================================================================
    activo BOOLEAN DEFAULT TRUE,                        -- Horario activo para usar
    prioridad INTEGER DEFAULT 0,                        -- Orden de preferencia (mayor = m√°s prioritario)
    creado_automaticamente BOOLEAN DEFAULT FALSE,       -- Si fue generado por el sistema

    -- ====================================================================
    -- ‚è∞ SECCI√ìN: TIMESTAMPS DE AUDITOR√çA
    -- ====================================================================
    creado_en TIMESTAMPTZ DEFAULT NOW(),
    actualizado_en TIMESTAMPTZ DEFAULT NOW(),
    creado_por INTEGER REFERENCES usuarios(id),
    actualizado_por INTEGER REFERENCES usuarios(id),

    -- ====================================================================
    -- ‚úÖ SECCI√ìN: VALIDACIONES EXHAUSTIVAS
    -- ====================================================================
    CONSTRAINT valid_horario_base
        CHECK (hora_inicio < hora_fin),
    CONSTRAINT valid_duracion_minima_horario
        CHECK (hora_fin - hora_inicio >= INTERVAL '15 minutes'),
    CONSTRAINT valid_vigencia_temporal
        CHECK (fecha_fin IS NULL OR fecha_fin >= fecha_inicio),
    CONSTRAINT valid_precio_premium
        CHECK (precio_premium >= 0 AND precio_premium <= 999.99),
    CONSTRAINT valid_capacidad_maxima
        CHECK (
            -- Breaks y almuerzos pueden tener capacidad 0 (no permiten citas)
            (tipo_horario IN ('break', 'almuerzo') AND capacidad_maxima >= 0 AND capacidad_maxima <= 50)
            OR
            -- Otros tipos de horarios requieren capacidad > 0
            (tipo_horario NOT IN ('break', 'almuerzo') AND capacidad_maxima > 0 AND capacidad_maxima <= 50)
        ),
    CONSTRAINT valid_tipo_horario
        CHECK (tipo_horario IN ('regular', 'break', 'almuerzo', 'premium')),
    CONSTRAINT valid_configuracion_permite_citas
        CHECK (
            CASE tipo_horario
                WHEN 'break' THEN permite_citas = FALSE
                WHEN 'almuerzo' THEN permite_citas = FALSE
                ELSE TRUE
            END
        ),

    -- üîí CONSTRAINT √öNICO MEJORADO
    -- Permite m√∫ltiples horarios por d√≠a siempre que no se solapen
    -- Nota: Usamos tsrange con fecha dummy para simular timerange
    EXCLUDE USING gist (
        profesional_id WITH =,
        dia_semana WITH =,
        fecha_inicio WITH =,
        tsrange(
            ('2000-01-01'::date + hora_inicio)::timestamp,
            ('2000-01-01'::date + hora_fin)::timestamp,
            '[)'
        ) WITH &&
    ) WHERE (activo = TRUE)
);

-- ====================================================================
-- üìä √çNDICES ESPECIALIZADOS PARA PERFORMANCE
-- ====================================================================

-- √çndice principal para b√∫squedas por profesional
CREATE INDEX idx_horarios_profesionales_profesional
    ON horarios_profesionales(profesional_id, activo) WHERE activo = TRUE;

-- √çndice para b√∫squedas por d√≠a de semana
CREATE INDEX idx_horarios_profesionales_dia_activo
    ON horarios_profesionales(dia_semana, activo, permite_citas)
    WHERE activo = TRUE;

-- √çndice para horarios con vigencia temporal
CREATE INDEX idx_horarios_profesionales_vigencia
    ON horarios_profesionales(fecha_inicio, fecha_fin, activo)
    WHERE activo = TRUE;

-- √çndice para horarios premium
CREATE INDEX idx_horarios_profesionales_premium
    ON horarios_profesionales(profesional_id, precio_premium)
    WHERE activo = TRUE AND precio_premium > 0;

-- √çndice compuesto para generaci√≥n de disponibilidad
CREATE INDEX idx_horarios_profesionales_generacion
    ON horarios_profesionales(profesional_id, dia_semana, permite_citas, activo)
    WHERE activo = TRUE AND permite_citas = TRUE;

-- ====================================================================
-- üîí POL√çTICAS RLS PARA SEGURIDAD MULTI-TENANT
-- ====================================================================

-- Habilitar RLS en la tabla
ALTER TABLE horarios_profesionales ENABLE ROW LEVEL SECURITY;

-- Pol√≠tica unificada para acceso multi-tenant
CREATE POLICY horarios_profesionales_unified_access ON horarios_profesionales
    FOR ALL
    TO saas_app
    USING (
        -- Super admin tiene acceso total
        current_setting('app.current_user_role', true) = 'super_admin'
        -- Bypass RLS para funciones de sistema
        OR current_setting('app.bypass_rls', true) = 'true'
        -- Acceso por organizaci√≥n para usuarios regulares
        OR (
            current_setting('app.current_tenant_id', true) ~ '^[0-9]+$'
            AND organizacion_id = COALESCE(NULLIF(current_setting('app.current_tenant_id', true), '')::INTEGER, 0)
        )
    );

-- ====================================================================
-- ‚ö° FUNCIONES ESPECIALIZADAS PARA HORARIOS PROFESIONALES
-- ====================================================================

-- ====================================================================
-- üîç FUNCI√ìN 2: VALIDAR SOLAPAMIENTO DE HORARIOS
-- ====================================================================
-- Valida que no haya solapamientos entre horarios del mismo profesional
-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
CREATE OR REPLACE FUNCTION validar_solapamiento_horarios()
RETURNS TRIGGER AS $$
DECLARE
    v_conflictos INTEGER;
BEGIN
    -- Verificar solapamientos con otros horarios activos del mismo profesional en el mismo d√≠a
    SELECT COUNT(*)
    INTO v_conflictos
    FROM horarios_profesionales hp
    WHERE hp.profesional_id = NEW.profesional_id
    AND hp.dia_semana = NEW.dia_semana
    AND hp.activo = TRUE
    AND hp.id != COALESCE(NEW.id, 0)  -- Excluir el registro actual en caso de UPDATE
    AND (
        -- Verificar solapamiento temporal
        (NEW.fecha_inicio <= COALESCE(hp.fecha_fin, '2099-12-31') AND
         COALESCE(NEW.fecha_fin, '2099-12-31') >= hp.fecha_inicio)
        AND
        -- Verificar solapamiento de horarios
        (NEW.hora_inicio < hp.hora_fin AND NEW.hora_fin > hp.hora_inicio)
    );

    IF v_conflictos > 0 THEN
        RAISE EXCEPTION 'Horario se solapa con otro horario existente del profesional en el mismo d√≠a';
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ====================================================================
-- üîÑ FUNCI√ìN 3: ACTUALIZAR TIMESTAMP HORARIOS PROFESIONALES
-- ====================================================================
-- Actualiza autom√°ticamente el timestamp al modificar horarios
-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
CREATE OR REPLACE FUNCTION actualizar_timestamp_horarios_profesionales()
RETURNS TRIGGER AS $$
BEGIN
    NEW.actualizado_en = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ====================================================================
-- ‚ö° TRIGGERS AUTOM√ÅTICOS
-- ====================================================================

-- TRIGGER 1: Validaci√≥n de solapamientos
CREATE TRIGGER trigger_validar_solapamiento_horarios
    BEFORE INSERT OR UPDATE ON horarios_profesionales
    FOR EACH ROW EXECUTE FUNCTION validar_solapamiento_horarios();

-- TRIGGER 2: Actualizaci√≥n autom√°tica de timestamps
CREATE TRIGGER trigger_actualizar_timestamp_horarios_prof
    BEFORE UPDATE ON horarios_profesionales
    FOR EACH ROW EXECUTE FUNCTION actualizar_timestamp_horarios_profesionales();

-- ====================================================================
-- üìù COMENTARIOS PARA DOCUMENTACI√ìN
-- ====================================================================

COMMENT ON TABLE horarios_profesionales IS
'Plantillas de horarios base de profesionales para generar autom√°ticamente slots de disponibilidad';

COMMENT ON COLUMN horarios_profesionales.tipo_horario IS
'Tipo de horario: regular (trabajo), break (descanso), almuerzo, premium (con recargo), especial';

COMMENT ON COLUMN horarios_profesionales.permite_citas IS
'FALSE para breaks y almuerzos donde no se pueden agendar citas';

COMMENT ON COLUMN horarios_profesionales.fecha_inicio IS
'Fecha desde la cual este horario es v√°lido (√∫til para cambios estacionales)';

COMMENT ON COLUMN horarios_profesionales.fecha_fin IS
'Fecha hasta la cual este horario es v√°lido (NULL = indefinido)';

-- ====================================================================
-- üìù DOCUMENTACI√ìN DE POL√çTICAS RLS
-- ====================================================================
-- Comentarios de pol√≠ticas que se crean en 08-rls-policies.sql
-- pero se documentan aqu√≠ porque la tabla se crea en este archivo
-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

-- Pol√≠tica de horarios profesionales
COMMENT ON POLICY horarios_profesionales_unified_access ON horarios_profesionales IS
'Acceso a configuraci√≥n de horarios de profesionales:
- Usuario accede solo a horarios de su organizaci√≥n
- Super admin tiene acceso global
- Validaci√≥n de formato num√©rico en tenant_id

Usado para: Configuraci√≥n de disponibilidad semanal, breaks, horarios premium.';

-- ====================================================================
-- üìä DATOS DE EJEMPLO PARA TESTING
-- ====================================================================

-- Estos datos se pueden usar para testing, comentar en producci√≥n
/*
-- Ejemplo: Barbero con horario regular Lunes-Viernes
INSERT INTO horarios_profesionales (
    organizacion_id, profesional_id, dia_semana, hora_inicio, hora_fin,
    tipo_horario, nombre_horario
) VALUES
-- Lunes a Viernes 9:00-18:00 con almuerzo 13:00-14:00
(1, 1, 1, '09:00', '13:00', 'regular', 'Horario Matutino'),
(1, 1, 1, '13:00', '14:00', 'almuerzo', 'Hora de Almuerzo'),
(1, 1, 1, '14:00', '18:00', 'regular', 'Horario Vespertino'),
(1, 1, 2, '09:00', '13:00', 'regular', 'Horario Matutino'),
(1, 1, 2, '13:00', '14:00', 'almuerzo', 'Hora de Almuerzo'),
(1, 1, 2, '14:00', '18:00', 'regular', 'Horario Vespertino');
*/