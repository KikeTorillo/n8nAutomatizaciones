# üìÅ Estructura del Backend - Documentaci√≥n T√©cnica

**Proyecto:** Sistema SaaS de Agendamiento Multi-Tenant
**Fecha:** Enero 2025
**Estado:** Fundaci√≥n Completada (70%)

---

## üèóÔ∏è Resumen de la Implementaci√≥n

El backend est√° dise√±ado con **PostgreSQL nativo** (sin ORM) para m√°ximo control sobre las consultas SQL y aprovechamiento completo de los √≠ndices optimizados de la base de datos multi-tenant.

### üéØ **Caracter√≠sticas Principales**
- **Multi-tenant** con Row Level Security autom√°tico
- **Multi-database** con pools de conexi√≥n especializados
- **JWT Authentication** con refresh tokens
- **Logging estructurado** para observabilidad
- **Rate limiting** y seguridad enterprise
- **Graceful shutdown** y health checks

---

## üìÇ Estructura de Carpetas Detallada

```
backend/
‚îú‚îÄ‚îÄ src/                          # C√≥digo fuente principal
‚îÇ   ‚îú‚îÄ‚îÄ config/                   # ‚úÖ Configuraciones del sistema
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database.js           # Pool multi-DB con PostgreSQL nativo
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ auth.js               # JWT, bcrypt y validaciones
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ database/                 # üîÑ Queries SQL y modelos de datos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ queries/              # Queries organizadas por entidad
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/               # Definiciones de modelos (sin ORM)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ migrations/           # Scripts de migraci√≥n SQL
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ controllers/              # üîÑ L√≥gica de controladores HTTP
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AuthController.js     # Login, registro, refresh tokens
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CitasController.js    # CRUD completo de citas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ClientesController.js # CRUD con b√∫squeda por tel√©fono
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ WebhooksController.js # Webhooks para n8n
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ services/                 # üîÑ L√≥gica de negocio
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CitasService.js       # L√≥gica de agendamiento
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ N8nService.js         # Integraci√≥n con n8n
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WhatsAppService.js    # Integraci√≥n Evolution API
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AnalyticsService.js   # M√©tricas y reportes
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ middleware/               # üîÑ Middlewares personalizados
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.js               # Verificaci√≥n JWT y tenant
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tenant.js             # Aislamiento multi-tenant
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ validation.js         # Validaci√≥n con Joi
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ rateLimiting.js       # Rate limiting personalizado
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ routes/                   # üîÑ Definici√≥n de rutas API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api/v1/               # APIs versionadas
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.js           # Rutas de autenticaci√≥n
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ citas.js          # Rutas de citas
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ clientes.js       # Rutas de clientes
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ disponibilidad.js # Rutas de disponibilidad
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ webhooks.js       # Rutas de webhooks
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.js              # Router principal
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ utils/                    # ‚úÖ Utilidades y helpers
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logger.js             # Logging estructurado Winston
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ helpers.js            # Helpers para validaci√≥n, fechas, etc.
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ validators/               # üîÑ Schemas de validaci√≥n
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ authSchemas.js        # Validaciones de autenticaci√≥n
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ citaSchemas.js        # Validaciones de citas
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ clienteSchemas.js     # Validaciones de clientes
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ app.js                    # ‚úÖ Aplicaci√≥n principal Express
‚îÇ
‚îú‚îÄ‚îÄ tests/                        # üîÑ Tests automatizados
‚îÇ   ‚îú‚îÄ‚îÄ unit/                     # Tests unitarios
‚îÇ   ‚îú‚îÄ‚îÄ integration/              # Tests de integraci√≥n
‚îÇ   ‚îî‚îÄ‚îÄ fixtures/                 # Datos de prueba
‚îÇ
‚îú‚îÄ‚îÄ docs/                         # üìö Documentaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ api.yml                   # Especificaci√≥n OpenAPI/Swagger
‚îÇ   ‚îî‚îÄ‚îÄ development.md            # Gu√≠a de desarrollo
‚îÇ
‚îú‚îÄ‚îÄ scripts/                      # üîÑ Scripts de utilidad
‚îÇ   ‚îú‚îÄ‚îÄ migrate.js                # Migraciones de BD
‚îÇ   ‚îú‚îÄ‚îÄ seed.js                   # Datos de prueba
‚îÇ   ‚îî‚îÄ‚îÄ deploy.js                 # Script de deploy
‚îÇ
‚îú‚îÄ‚îÄ logs/                         # üìä Logs de la aplicaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ app.log                   # Log general
‚îÇ   ‚îú‚îÄ‚îÄ error.log                 # Log de errores
‚îÇ   ‚îî‚îÄ‚îÄ access.log                # Log de acceso
‚îÇ
‚îú‚îÄ‚îÄ .env.example                  # ‚úÖ Variables de entorno ejemplo
‚îú‚îÄ‚îÄ .gitignore                    # ‚úÖ Archivos ignorados
‚îú‚îÄ‚îÄ package.json                  # ‚úÖ Dependencias y scripts
‚îî‚îÄ‚îÄ README.md                     # ‚úÖ Documentaci√≥n principal
```

**Leyenda:**
- ‚úÖ **Completado** - Archivo/carpeta implementado
- üîÑ **Pendiente** - Por implementar en siguientes sprints

---

## üîß Componentes T√©cnicos Implementados

### **1. Sistema de Base de Datos Multi-Pool**

```javascript
// database.js - Configuraci√≥n especializada por uso
pools: {
  saas: 20 conexiones m√°x     // BD principal SaaS
  n8n: 10 conexiones m√°x      // Sincronizaci√≥n n8n
  evolution: 8 conexiones m√°x // WhatsApp Evolution API
  chat: 5 conexiones m√°x      // Historiales de IA
}
```

**Caracter√≠sticas:**
- **Connection pooling** optimizado por base de datos
- **Health checks** autom√°ticos para todas las BDs
- **Logging** de performance para queries >100ms
- **Transactions** con soporte multi-tenant

### **2. Sistema de Autenticaci√≥n JWT**

```javascript
// auth.js - Configuraci√≥n enterprise
features: {
  jwt: "Access + Refresh tokens",
  bcrypt: "12 rounds de encriptaci√≥n",
  validation: "Fortaleza de contrase√±a",
  tokens: "Verificaci√≥n con issuer/audience"
}
```

**Caracter√≠sticas:**
- **JWT pair** (access + refresh tokens)
- **Password strength** validation con scores
- **Secure tokens** para reset de contrase√±a
- **Verification codes** para 2FA (futuro)

### **3. Sistema de Logging Estructurado**

```javascript
// logger.js - Logging contextual
contexts: {
  httpRequest: "Requests con duraci√≥n y metadata",
  dbOperation: "Queries con performance tracking",
  auth: "Eventos de autenticaci√≥n",
  integration: "Llamadas a APIs externas",
  webhook: "Webhooks enviados/recibidos",
  cita: "Operaciones de citas (core business)",
  tenant: "Operaciones multi-tenant",
  security: "Eventos de seguridad"
}
```

**Caracter√≠sticas:**
- **Structured logging** con Winston
- **Context-aware** para diferentes operaciones
- **Performance monitoring** autom√°tico
- **Security events** tracking

### **4. Aplicaci√≥n Express Robusta**

```javascript
// app.js - Middlewares de seguridad
security: {
  helmet: "Headers de seguridad",
  cors: "Multi-origen configurado",
  rateLimit: "100 req/15min por IP",
  compression: "Compresi√≥n de respuestas",
  gracefulShutdown: "Cierre ordenado de conexiones"
}
```

**Caracter√≠sticas:**
- **Health checks** para todas las dependencias
- **Error handling** centralizado y contextual
- **Request logging** con duraci√≥n y metadata
- **Graceful shutdown** para se√±ales del sistema

---

## üóÑÔ∏è Estrategia de Base de Datos

### **Conexiones Especializadas por Uso**

| Base de Datos | Prop√≥sito | Pool Size | Usuario |
|---------------|-----------|-----------|---------|
| **postgres_db** | SaaS principal (citas, clientes, etc.) | 20 | `saas_app` |
| **n8n_db** | Sincronizaci√≥n de workflows | 10 | `n8n_app` |
| **evolution_db** | Datos de WhatsApp/sesiones | 8 | `evolution_app` |
| **chat_memories_db** | Historiales de IA conversacional | 5 | `chat_app` |

### **Multi-Tenant con RLS Autom√°tico**

```javascript
// Cada request configura autom√°ticamente el tenant
await database.query('SET app.current_tenant_id = $1', [organizacion_id]);

// Todas las queries subsecuentes respetan RLS autom√°ticamente
const citas = await database.query('SELECT * FROM citas WHERE activo = true');
// ‚Üë Solo ve citas de su organizaci√≥n debido a RLS
```

### **Performance y Monitoreo**

```javascript
// Logging autom√°tico de queries lentas
if (duration > 100) {
  logger.warn('Query lenta detectada', {
    query: query.substring(0, 100) + '...',
    duration,
    rowCount: result.rowCount,
    tenantId
  });
}
```

---

## üõ°Ô∏è Seguridad Multi-Tenant

### **Aislamiento Autom√°tico**
- **Row Level Security** en todas las tablas cr√≠ticas
- **Tenant context** configurado por request
- **JWT verification** con tenant validation
- **Rate limiting** por IP y tenant

### **Validaciones Robustas**
- **Input sanitization** para prevenir SQL injection
- **Email/phone validation** con regex
- **Password strength** scoring autom√°tico
- **SQL input filtering** b√°sico implementado

---

## üìä Utilidades y Helpers

### **ResponseHelper** - Respuestas HTTP Estandarizadas
```javascript
ResponseHelper.success(res, data, message, statusCode);
ResponseHelper.error(res, message, statusCode, errors);
ResponseHelper.paginated(res, data, pagination);
ResponseHelper.validationError(res, errors);
```

### **ValidationHelper** - Validaciones de Negocio
```javascript
ValidationHelper.isValidEmail(email);
ValidationHelper.isValidMexicanPhone(phone);
ValidationHelper.normalizePhone(phone);
ValidationHelper.isValidDate(dateString);
ValidationHelper.isFutureDate(dateString);
```

### **DateHelper** - Manejo de Fechas y Horas
```javascript
DateHelper.getCurrentDate(timezone);
DateHelper.minutesBetween(startTime, endTime);
DateHelper.addMinutes(time, minutes);
DateHelper.formatDate(dateString);
```

### **CodeGenerator** - C√≥digos √önicos
```javascript
CodeGenerator.generateCitaCode();        // ABC12345
CodeGenerator.generateSlug(name);        // mi-negocio-slug
CodeGenerator.generateTenantCode(name);  // mi-negocio-abc
```

---

## üöÄ Pr√≥ximos Pasos de Implementaci√≥n

### **Sprint 1 - Completar Semana 1 (30% restante)**

#### **1. Middleware de Autenticaci√≥n**
```javascript
// middleware/auth.js
const authenticateAndSetTenant = async (req, res, next) => {
  // 1. Verificar JWT
  // 2. Obtener usuario y organizaci√≥n
  // 3. Configurar tenant en BD
  // 4. Agregar a request context
};
```

#### **2. Modelos de Datos sin ORM**
```javascript
// database/models/CitaModel.js
class CitaModel {
  static async findByOrganizacion(organizacionId) {
    // Query SQL nativa con par√°metros seguros
  }

  static async create(citaData, organizacionId) {
    // Insert con validaciones y tenant context
  }
}
```

#### **3. Controladores B√°sicos**
```javascript
// controllers/CitasController.js
class CitasController {
  async list(req, res) {
    // GET /api/v1/citas con paginaci√≥n
  }

  async create(req, res) {
    // POST /api/v1/citas con validaci√≥n
  }
}
```

#### **4. Validadores con Joi**
```javascript
// validators/citaSchemas.js
const createCitaSchema = Joi.object({
  cliente_id: Joi.number().required(),
  servicio_id: Joi.number().required(),
  fecha_cita: Joi.date().min('now').required()
});
```

#### **5. Setup de Testing**
```javascript
// tests/unit/auth.test.js
describe('AuthController', () => {
  test('should login with valid credentials', async () => {
    // Test de login exitoso
  });
});
```

---

## üìà M√©tricas de Progreso

### **Estado Actual (Semana 1)**
- **Completado:** 70%
- **Arquitectura:** ‚úÖ 100%
- **Configuraci√≥n:** ‚úÖ 100%
- **Utilities:** ‚úÖ 100%
- **Aplicaci√≥n base:** ‚úÖ 100%
- **APIs:** üîÑ 0% (pr√≥ximo)
- **Tests:** üîÑ 0% (pr√≥ximo)

### **Target Semana 2**
- **APIs CRUD:** üéØ 100%
- **Middleware:** üéØ 100%
- **Validadores:** üéØ 100%
- **Tests b√°sicos:** üéØ 80%
- **Documentaci√≥n Swagger:** üéØ 60%

---

## üîó Integraci√≥n con Ecosistema Existente

### **Base de Datos**
- ‚úÖ **Conecta directamente** con esquemas SQL existentes
- ‚úÖ **Respeta RLS** y pol√≠ticas multi-tenant implementadas
- ‚úÖ **Usa √≠ndices optimizados** para m√°ximo rendimiento

### **n8n Workflows**
- üîÑ **Webhooks bidireccionales** para sincronizaci√≥n
- üîÑ **APIs espec√≠ficas** para crear/actualizar citas desde n8n
- üîÑ **Event notifications** para flujos automatizados

### **Evolution API (WhatsApp)**
- üîÑ **Integraci√≥n nativa** con base de datos de WhatsApp
- üîÑ **Sincronizaci√≥n de sesiones** y mensajes
- üîÑ **Multi-instancia** por organizaci√≥n

---

**üìù Documento t√©cnico actualizado en tiempo real**
**üîÑ √öltima actualizaci√≥n:** Enero 2025
**üë®‚Äçüíª Mantenido por:** Equipo Backend SaaS