# üèóÔ∏è Arquitectura: MCP Server vs Endpoints IA Dedicados

## üí° Propuesta: MCP Server para Agente IA

### La Idea

**En lugar de**:
```
Agente IA ‚Üí Endpoints /automatica (sin auth) ‚Üí Backend
```

**Usar**:
```
Agente IA ‚Üí MCP Server ‚Üí Endpoints manuales (con auth) ‚Üí Backend
```

---

## ‚úÖ Ventajas de Usar MCP + Endpoints Manuales

### 1Ô∏è‚É£ **Elimina Duplicaci√≥n de C√≥digo**

**Problema actual**: Dos endpoints para lo mismo

```javascript
// Manual
POST /api/v1/citas
- Requiere: cliente_id, profesional_id, fecha exacta, hora exacta

// IA
POST /api/v1/citas/automatica
- Requiere: telefono_cliente, servicio_id, fecha_solicitada, turno_preferido
- Hace: buscar/crear cliente, buscar profesional, buscar horario
```

**Con MCP**: Un solo endpoint + tools del agente

```javascript
// Solo un endpoint
POST /api/v1/citas

// El MCP server provee tools para:
- buscarClientePorTelefono(telefono)
- crearCliente(nombre, telefono, email)
- buscarServicioPorDescripcion(descripcion)
- buscarHorariosDisponibles(servicio_id, fecha, turno)
- crearCita(cliente_id, profesional_id, servicio_id, fecha, hora)
```

---

### 2Ô∏è‚É£ **Agente IA con M√°s Control y Contexto**

**Arquitectura actual** (IA ciega):
```
Cliente: "Necesito un corte ma√±ana en la tarde"
    ‚Üì
Agente extrae: servicio="corte", fecha="ma√±ana", turno="tarde"
    ‚Üì
POST /automatica ‚Üí Backend decide todo
    ‚Üì
Backend responde: "Cita a las 16:00 con Carlos"
    ‚Üì
Agente: "Ok, te confirm√© a las 16:00 con Carlos" (sin saber por qu√©)
```

**Con MCP** (IA informada):
```
Cliente: "Necesito un corte ma√±ana en la tarde"
    ‚Üì
Agente piensa: "Voy a buscar opciones"
    ‚Üì
Tool: buscarHorariosDisponibles("corte", "ma√±ana", "tarde")
    ‚Üì
Response: [
  {hora: "14:00", profesional: "Carlos", disponible: true},
  {hora: "15:00", profesional: "Juan", disponible: true},
  {hora: "16:00", profesional: "Carlos", disponible: true}
]
    ‚Üì
Agente al cliente: "Tengo disponible a las 14:00, 15:00 o 16:00.
                    Carlos est√° libre a las 14:00 y 16:00.
                    ¬øCu√°l prefieres?"
    ‚Üì
Cliente: "A las 16:00 est√° bien"
    ‚Üì
Tool: crearCita(cliente_id, carlos_id, corte_id, "ma√±ana", "16:00")
    ‚Üì
Agente: "Perfecto! Confirmado a las 16:00 con Carlos.
         C√≥digo: ORG001-20251010-001"
```

**Ventaja**: El agente puede **conversar** y **negociar** con el cliente en lugar de solo confirmar.

---

### 3Ô∏è‚É£ **Reutilizaci√≥n de Toda la API Existente**

Con MCP, el agente puede usar **TODOS** los endpoints:

```javascript
// El agente puede:
- Listar servicios disponibles
- Buscar profesionales por especialidad
- Ver historial de citas del cliente
- Consultar disponibilidad de m√∫ltiples d√≠as
- Modificar citas existentes
- Cancelar citas
- Confirmar asistencia
- Y cualquier endpoint futuro autom√°ticamente
```

**Sin necesidad de crear endpoints especiales de IA para cada operaci√≥n.**

---

### 4Ô∏è‚É£ **Autenticaci√≥n Simplificada**

**Arquitectura actual**:
- Endpoints manual: JWT requerido
- Endpoints IA: Sin auth, validaci√≥n manual de `organizacion_id`
- Problema: Dos flujos de seguridad diferentes

**Con MCP**:
- Un solo flujo: JWT para todo
- El MCP server se autentica como un "usuario bot"
- Toda la auditor√≠a y RLS funciona normal
- Logs muestran: "creado_por: usuario_bot_whatsapp"

```javascript
// Crear usuario bot para cada organizaci√≥n
{
  "email": "bot.whatsapp@barberia.com",
  "rol": "bot",
  "organizacion_id": 1
}

// MCP server usa este usuario
const jwt = await login("bot.whatsapp@barberia.com", "password");

// Todas las llamadas usan ese JWT
headers: { "Authorization": `Bearer ${jwt}` }
```

---

## üèóÔ∏è Dise√±o del MCP Server

### Estructura del MCP

```typescript
// mcp-server/tools.ts

export const tools = [
  {
    name: "buscar_cliente_por_telefono",
    description: "Busca un cliente existente por su n√∫mero de tel√©fono",
    inputSchema: {
      type: "object",
      properties: {
        telefono: {
          type: "string",
          description: "N√∫mero de tel√©fono en formato internacional (+52...)"
        }
      },
      required: ["telefono"]
    }
  },

  {
    name: "crear_cliente",
    description: "Crea un nuevo cliente en el sistema",
    inputSchema: {
      type: "object",
      properties: {
        nombre: { type: "string" },
        telefono: { type: "string" },
        email: { type: "string" }
      },
      required: ["nombre", "telefono"]
    }
  },

  {
    name: "buscar_servicios",
    description: "Busca servicios por descripci√≥n o categor√≠a",
    inputSchema: {
      type: "object",
      properties: {
        query: {
          type: "string",
          description: "Descripci√≥n del servicio (ej: 'corte', 'barba', 'manicure')"
        }
      },
      required: ["query"]
    }
  },

  {
    name: "buscar_horarios_disponibles",
    description: "Busca horarios disponibles para un servicio en una fecha y turno",
    inputSchema: {
      type: "object",
      properties: {
        servicio_id: { type: "number" },
        fecha: {
          type: "string",
          description: "Fecha en formato YYYY-MM-DD"
        },
        turno: {
          type: "string",
          enum: ["ma√±ana", "tarde", "noche", "cualquiera"],
          description: "Turno preferido"
        }
      },
      required: ["servicio_id", "fecha"]
    }
  },

  {
    name: "crear_cita",
    description: "Crea una nueva cita con datos espec√≠ficos",
    inputSchema: {
      type: "object",
      properties: {
        cliente_id: { type: "number" },
        profesional_id: { type: "number" },
        servicio_id: { type: "number" },
        fecha_cita: { type: "string" },
        hora_inicio: { type: "string" },
        hora_fin: { type: "string" }
      },
      required: ["cliente_id", "profesional_id", "servicio_id", "fecha_cita", "hora_inicio", "hora_fin"]
    }
  },

  {
    name: "listar_citas_cliente",
    description: "Lista las citas de un cliente por tel√©fono",
    inputSchema: {
      type: "object",
      properties: {
        telefono: { type: "string" },
        estados: {
          type: "array",
          items: { type: "string" },
          description: "Estados de citas a incluir"
        }
      },
      required: ["telefono"]
    }
  },

  {
    name: "cancelar_cita",
    description: "Cancela una cita por c√≥digo",
    inputSchema: {
      type: "object",
      properties: {
        codigo_cita: { type: "string" },
        motivo: { type: "string" }
      },
      required: ["codigo_cita"]
    }
  }
];
```

---

### Implementaci√≥n del MCP Server

```typescript
// mcp-server/server.ts

import { Server } from "@modelcontextprotocol/sdk/server/index.js";
import { StdioServerTransport } from "@modelcontextprotocol/sdk/server/stdio.js";
import axios from "axios";

const API_BASE_URL = "http://localhost:3000/api/v1";
let authToken: string | null = null;

// Autenticaci√≥n al iniciar
async function authenticate() {
  const response = await axios.post(`${API_BASE_URL}/auth/login`, {
    email: process.env.BOT_EMAIL,
    password: process.env.BOT_PASSWORD
  });
  authToken = response.data.data.token;
}

// Helper para hacer requests autenticados
async function apiRequest(method: string, endpoint: string, data?: any) {
  if (!authToken) await authenticate();

  return axios({
    method,
    url: `${API_BASE_URL}${endpoint}`,
    headers: { Authorization: `Bearer ${authToken}` },
    data
  });
}

// Implementaci√≥n de tools
const toolHandlers = {

  async buscar_cliente_por_telefono({ telefono }: { telefono: string }) {
    try {
      // Usar endpoint de b√∫squeda de clientes
      const response = await apiRequest('GET', `/clientes/buscar-por-telefono?telefono=${encodeURIComponent(telefono)}`);

      if (response.data.success) {
        return {
          encontrado: true,
          cliente: response.data.data
        };
      }
    } catch (error: any) {
      if (error.response?.status === 404) {
        return { encontrado: false };
      }
      throw error;
    }
  },

  async crear_cliente({ nombre, telefono, email }: any) {
    const response = await apiRequest('POST', '/clientes', {
      nombre,
      telefono,
      email,
      activo: true
    });
    return response.data.data;
  },

  async buscar_servicios({ query }: { query: string }) {
    const response = await apiRequest('GET', '/servicios');
    const servicios = response.data.data.servicios;

    // Filtrar por query (simple)
    const filtrados = servicios.filter((s: any) =>
      s.nombre.toLowerCase().includes(query.toLowerCase()) ||
      s.descripcion?.toLowerCase().includes(query.toLowerCase())
    );

    return filtrados;
  },

  async buscar_horarios_disponibles({ servicio_id, fecha, turno = 'cualquiera' }: any) {
    // Aqu√≠ necesitar√≠as un endpoint nuevo o usar uno existente
    // Opci√≥n 1: Crear endpoint GET /servicios/:id/disponibilidad
    // Opci√≥n 2: Buscar en horarios_disponibilidad directamente

    // Por ahora, simulado:
    const response = await apiRequest('GET', `/horarios/disponibilidad?servicio_id=${servicio_id}&fecha=${fecha}&turno=${turno}`);
    return response.data.data;
  },

  async crear_cita(params: any) {
    const response = await apiRequest('POST', '/citas', params);
    return response.data.data;
  },

  async listar_citas_cliente({ telefono, estados = ['pendiente', 'confirmada'] }: any) {
    // Primero buscar cliente
    const cliente = await toolHandlers.buscar_cliente_por_telefono({ telefono });
    if (!cliente.encontrado) {
      return { citas: [] };
    }

    // Luego listar sus citas
    const response = await apiRequest('GET', `/citas?cliente_id=${cliente.cliente.id}&estado=${estados.join(',')}`);
    return response.data.data;
  },

  async cancelar_cita({ codigo_cita, motivo }: any) {
    // Primero buscar cita por c√≥digo
    const citasResponse = await apiRequest('GET', `/citas?busqueda=${codigo_cita}`);
    const cita = citasResponse.data.data.citas[0];

    if (!cita) {
      throw new Error('Cita no encontrada');
    }

    // Cancelar (DELETE)
    await apiRequest('DELETE', `/citas/${cita.id}`);

    return { cancelada: true, codigo: codigo_cita };
  }
};

// Server MCP
const server = new Server(
  {
    name: "agendamiento-saas",
    version: "1.0.0",
  },
  {
    capabilities: {
      tools: {},
    },
  }
);

server.setRequestHandler("tools/list", async () => ({
  tools: tools
}));

server.setRequestHandler("tools/call", async (request) => {
  const { name, arguments: args } = request.params;

  const handler = toolHandlers[name as keyof typeof toolHandlers];
  if (!handler) {
    throw new Error(`Tool not found: ${name}`);
  }

  const result = await handler(args as any);

  return {
    content: [
      {
        type: "text",
        text: JSON.stringify(result, null, 2)
      }
    ]
  };
});

async function main() {
  await authenticate();

  const transport = new StdioServerTransport();
  await server.connect(transport);
}

main();
```

---

## üé® Flujo Conversacional con MCP

### Ejemplo: Cliente solicita cita

```
Cliente: "Hola! Necesito un corte de cabello para ma√±ana en la tarde"
    ‚Üì
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  AGENTE IA (Claude con MCP tools)                        ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë                                                          ‚ïë
‚ïë  Pensamiento del agente:                                 ‚ïë
‚ïë  1. Necesito identificar al cliente                      ‚ïë
‚ïë  2. Necesito encontrar el servicio "corte de cabello"    ‚ïë
‚ïë  3. Necesito buscar horarios disponibles ma√±ana tarde    ‚ïë
‚ïë  4. Necesito crear la cita                               ‚ïë
‚ïë                                                          ‚ïë
‚ïë  Ejecuta tools:                                          ‚ïë
‚ïë                                                          ‚ïë
‚ïë  üîß buscar_cliente_por_telefono("+5215544332211")       ‚ïë
‚ïë     ‚Üí { encontrado: false }                              ‚ïë
‚ïë                                                          ‚ïë
‚ïë  [Agente decide crear cliente]                           ‚ïë
‚ïë                                                          ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
    ‚Üì
Agente ‚Üí Cliente: "¬°Hola! Veo que es tu primera vez con nosotros.
                   ¬øC√≥mo te llamas?"
    ‚Üì
Cliente: "Me llamo Mar√≠a"
    ‚Üì
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  AGENTE IA                                               ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë                                                          ‚ïë
‚ïë  üîß crear_cliente({                                      ‚ïë
‚ïë       nombre: "Mar√≠a",                                   ‚ïë
‚ïë       telefono: "+5215544332211",                        ‚ïë
‚ïë       email: null                                        ‚ïë
‚ïë     })                                                   ‚ïë
‚ïë     ‚Üí { id: 123, nombre: "Mar√≠a", ... }                  ‚ïë
‚ïë                                                          ‚ïë
‚ïë  üîß buscar_servicios({ query: "corte de cabello" })     ‚ïë
‚ïë     ‚Üí [                                                  ‚ïë
‚ïë         { id: 8, nombre: "Corte Premium", precio: 350 }, ‚ïë
‚ïë         { id: 9, nombre: "Corte B√°sico", precio: 200 }   ‚ïë
‚ïë       ]                                                  ‚ïë
‚ïë                                                          ‚ïë
‚ïë  [Agente decide preguntar cu√°l servicio]                 ‚ïë
‚ïë                                                          ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
    ‚Üì
Agente ‚Üí Cliente: "Perfecto Mar√≠a! Tenemos:
                   - Corte Premium ($350)
                   - Corte B√°sico ($200)
                   ¬øCu√°l prefieres?"
    ‚Üì
Cliente: "El premium est√° bien"
    ‚Üì
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  AGENTE IA                                               ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë                                                          ‚ïë
‚ïë  üîß buscar_horarios_disponibles({                       ‚ïë
‚ïë       servicio_id: 8,                                    ‚ïë
‚ïë       fecha: "2025-10-10",                               ‚ïë
‚ïë       turno: "tarde"                                     ‚ïë
‚ïë     })                                                   ‚ïë
‚ïë     ‚Üí [                                                  ‚ïë
‚ïë         {                                                ‚ïë
‚ïë           hora_inicio: "14:00",                          ‚ïë
‚ïë           hora_fin: "14:45",                             ‚ïë
‚ïë           profesional: "Carlos Mart√≠nez",                ‚ïë
‚ïë           profesional_id: 2                              ‚ïë
‚ïë         },                                               ‚ïë
‚ïë         {                                                ‚ïë
‚ïë           hora_inicio: "16:00",                          ‚ïë
‚ïë           hora_fin: "16:45",                             ‚ïë
‚ïë           profesional: "Juan L√≥pez",                     ‚ïë
‚ïë           profesional_id: 3                              ‚ïë
‚ïë         }                                                ‚ïë
‚ïë       ]                                                  ‚ïë
‚ïë                                                          ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
    ‚Üì
Agente ‚Üí Cliente: "Tengo disponible:
                   - 2:00 PM con Carlos Mart√≠nez
                   - 4:00 PM con Juan L√≥pez
                   ¬øCu√°l te acomoda mejor?"
    ‚Üì
Cliente: "A las 4 est√° perfecto"
    ‚Üì
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  AGENTE IA                                               ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë                                                          ‚ïë
‚ïë  üîß crear_cita({                                         ‚ïë
‚ïë       cliente_id: 123,                                   ‚ïë
‚ïë       profesional_id: 3,                                 ‚ïë
‚ïë       servicio_id: 8,                                    ‚ïë
‚ïë       fecha_cita: "2025-10-10",                          ‚ïë
‚ïë       hora_inicio: "16:00:00",                           ‚ïë
‚ïë       hora_fin: "16:45:00"                               ‚ïë
‚ïë     })                                                   ‚ïë
‚ïë     ‚Üí {                                                  ‚ïë
‚ïë         codigo_cita: "ORG001-20251010-001",              ‚ïë
‚ïë         estado: "pendiente",                             ‚ïë
‚ïë         ...                                              ‚ïë
‚ïë       }                                                  ‚ïë
‚ïë                                                          ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
    ‚Üì
Agente ‚Üí Cliente: "¬°Listo Mar√≠a! ‚úÇÔ∏è

                   Tu Corte Premium est√° confirmado:
                   üìÖ Ma√±ana 10 de octubre
                   üïì 4:00 PM
                   üë§ Con Juan L√≥pez
                   üí∞ $350

                   üìã C√≥digo: ORG001-20251010-001

                   üí° Llega 5 min antes

                   ¬øNecesitas algo m√°s?"
```

---

## üìä Comparaci√≥n de Arquitecturas

| Aspecto | Endpoints IA Dedicados | MCP + Endpoints Manuales |
|---------|------------------------|--------------------------|
| **Duplicaci√≥n de c√≥digo** | ‚ùå Alta (2 endpoints por operaci√≥n) | ‚úÖ Baja (1 endpoint, tools reutilizables) |
| **Flexibilidad del agente** | ‚ö†Ô∏è Limitada (usa lo que tiene) | ‚úÖ Total (puede usar cualquier endpoint) |
| **Conversaci√≥n interactiva** | ‚ùå No (respuesta directa) | ‚úÖ S√≠ (negociaci√≥n con cliente) |
| **Autenticaci√≥n** | ‚ö†Ô∏è Dual (JWT + validaci√≥n manual) | ‚úÖ Unificada (solo JWT) |
| **Auditor√≠a** | ‚ö†Ô∏è Sin usuario identificado | ‚úÖ Usuario bot registrado |
| **Complejidad backend** | ‚ö†Ô∏è Media (2 controllers) | ‚úÖ Baja (1 controller) |
| **Complejidad n8n** | ‚ö†Ô∏è Media (prompt + HTTP) | ‚ö†Ô∏è Media (MCP config) |
| **Mantenimiento futuro** | ‚ùå Alto (2 lugares) | ‚úÖ Bajo (1 lugar) |
| **Capacidad del agente** | ‚ö†Ô∏è Limitada a endpoints IA | ‚úÖ Acceso a toda la API |

---

## üéØ Recomendaci√≥n

### ‚úÖ **Usar MCP + Endpoints Manuales**

**Razones**:

1. **Menos c√≥digo**: Eliminas ~400 l√≠neas de c√≥digo duplicado
2. **M√°s flexible**: El agente puede usar TODOS los endpoints
3. **Conversaci√≥n real**: El agente puede negociar opciones con el cliente
4. **Mejor auditor√≠a**: Usuario bot identificado en logs
5. **Futuro-proof**: Nuevos endpoints autom√°ticamente disponibles para IA

### ‚ö†Ô∏è **Mantener un endpoint especial** (opcional)

Podr√≠as mantener UN endpoint de conveniencia para crear citas que:
- Busca/crea cliente autom√°ticamente
- Busca horario compatible
- Crea cita

Pero que el agente lo use como una tool MCP, no directamente.

---

## üèóÔ∏è Arquitectura Recomendada

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  WhatsApp (Cliente)                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Evolution API (Webhook)                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  n8n Workflow                                           ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îÇ
‚îÇ  ‚îÇ  Nodo: AI Agent (Claude)                      ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                      ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ  Usa MCP tools:                               ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ  - buscar_cliente_por_telefono                ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ  - crear_cliente                              ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ  - buscar_servicios                           ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ  - buscar_horarios_disponibles                ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ  - crear_cita                                 ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ  - listar_citas_cliente                       ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ  - cancelar_cita                              ‚îÇ     ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ
‚îÇ                      ‚îÇ                                  ‚îÇ
‚îÇ                      ‚Üì                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îÇ
‚îÇ  ‚îÇ  MCP Server (agendamiento-saas)               ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ              ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ  - Autenticaci√≥n como usuario bot             ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ  - Tools que llaman API REST                  ‚îÇ     ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Backend API (Express + PostgreSQL)                     ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                      ‚îÇ
‚îÇ  Endpoints Manuales (protegidos con JWT):               ‚îÇ
‚îÇ  - POST   /api/v1/clientes                              ‚îÇ
‚îÇ  - GET    /api/v1/clientes/buscar-por-telefono          ‚îÇ
‚îÇ  - GET    /api/v1/servicios                             ‚îÇ
‚îÇ  - GET    /api/v1/horarios/disponibilidad               ‚îÇ
‚îÇ  - POST   /api/v1/citas                                 ‚îÇ
‚îÇ  - GET    /api/v1/citas                                 ‚îÇ
‚îÇ  - DELETE /api/v1/citas/:id                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìã Plan de Migraci√≥n

### Fase 1: Crear MCP Server

1. Crear proyecto MCP:
```bash
mkdir mcp-agendamiento
cd mcp-agendamiento
npm init -y
npm install @modelcontextprotocol/sdk axios dotenv
```

2. Implementar tools b√°sicos:
   - buscar_cliente_por_telefono
   - crear_cliente
   - buscar_servicios
   - crear_cita

3. Probar en n8n

### Fase 2: Agregar Endpoints Faltantes

1. Crear endpoint `GET /horarios/disponibilidad`
2. Modificar `GET /clientes/buscar-por-telefono` (si no existe)

### Fase 3: Migrar Flujo IA a MCP

1. Configurar MCP en n8n
2. Reemplazar nodos HTTP por AI Agent con MCP
3. Probar flujo completo

### Fase 4: Deprecar Endpoints IA (opcional)

1. Marcar endpoints `/automatica` como deprecated
2. Mantener por compatibilidad
3. Eventualmente eliminar

---

## üéØ Conclusi√≥n

**S√ç, tu idea es EXCELENTE** y es la arquitectura m√°s limpia y mantenible.

**Ventajas clave**:
- ‚úÖ Menos c√≥digo duplicado
- ‚úÖ Agente m√°s inteligente (puede negociar)
- ‚úÖ Una sola fuente de verdad
- ‚úÖ Mejor auditor√≠a
- ‚úÖ M√°s flexible para futuro

**√önico requisito nuevo**:
- Crear usuario bot por organizaci√≥n
- Implementar MCP server
- Posiblemente agregar endpoint de disponibilidad de horarios

**¬øQuieres que te ayude a implementar el MCP server y configurarlo en n8n?**
