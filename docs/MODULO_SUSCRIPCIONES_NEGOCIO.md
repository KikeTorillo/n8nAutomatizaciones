# MÃ³dulo Suscripciones Negocio

Sistema de facturaciÃ³n recurrente multi-propÃ³sito para Nexo ERP.

---

## Resumen Ejecutivo

| Aspecto | Valor |
|---------|-------|
| **PropÃ³sito** | FacturaciÃ³n recurrente con MercadoPago |
| **Modelo** | Dogfooding (Nexo lo usa + clientes lo usan) |
| **Estado** | Platform Billing âœ… | Customer Billing ğŸš§ | Seat-Based Billing âœ… |
| **Gateway** | MercadoPago (Preapproval API) |
| **Ãšltima revisiÃ³n** | 31 Enero 2026 (precio_semestral agregado) |

---

## Arquitectura de Dogfooding

El mÃ³dulo implementa **dos estrategias de facturaciÃ³n** en un mismo sistema:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ARQUITECTURA DOGFOODING                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  NEXO TEAM       â”‚         â”‚  CLIENTES DE NEXO            â”‚ â”‚
â”‚  â”‚  (org_id = 1)    â”‚         â”‚  (org_id = 2, 3, 4...)       â”‚ â”‚
â”‚  â”‚                  â”‚         â”‚                              â”‚ â”‚
â”‚  â”‚  â€¢ Planes Nexo   â”‚ â”€â”€â”€â”€â”€â”€â–º â”‚  â€¢ Usan Nexo                 â”‚ â”‚
â”‚  â”‚  â€¢ Cobra a orgs  â”‚         â”‚  â€¢ Pagan suscripciones       â”‚ â”‚
â”‚  â”‚  â€¢ Define lÃ­mitesâ”‚         â”‚  â€¢ Tienen lÃ­mites aplicados  â”‚ â”‚
â”‚  â”‚  â€¢ Define features         â”‚  â€¢ Tienen mÃ³dulos activados  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                                    â”‚                  â”‚
â”‚         â”‚ PLATFORM BILLING                   â”‚ CUSTOMER BILLING â”‚
â”‚         â”‚ (ACTIVO âœ…)                        â”‚ (PREPARADO ğŸš§)   â”‚
â”‚         â–¼                                    â–¼                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Organizaciones   â”‚         â”‚  Clientes de las             â”‚ â”‚
â”‚  â”‚ vinculadas como  â”‚         â”‚  organizaciones              â”‚ â”‚
â”‚  â”‚ clientes de Nexo â”‚         â”‚  (tabla clientes, sin org)   â”‚ â”‚
â”‚  â”‚                  â”‚         â”‚                              â”‚ â”‚
â”‚  â”‚ clientes.org_    â”‚         â”‚  â€¢ NO son organizaciones     â”‚ â”‚
â”‚  â”‚ vinculada_id â‰  0 â”‚         â”‚  â€¢ NO tienen mÃ³dulos         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚  â€¢ NO aplican lÃ­mites Nexo   â”‚ â”‚
â”‚                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Comparativa de Estrategias

| Aspecto | Platform Billing | Customer Billing |
|---------|------------------|------------------|
| **Vendor** | Nexo Team (org 1) | La organizaciÃ³n del usuario |
| **Comprador** | Organizaciones | Clientes del CRM |
| **Estrategia** | `PlatformBillingStrategy` | `CustomerBillingStrategy` |
| **ParÃ¡metro** | `es_venta_propia: false` | `es_venta_propia: true` |
| **Cliente** | `clientes.organizacion_vinculada_id â‰  NULL` | `clientes.organizacion_vinculada_id = NULL` |
| **LÃ­mites** | âœ… Se aplican (usuarios, sucursales) | âŒ No aplican |
| **Features â†’ MÃ³dulos** | âœ… Se activan automÃ¡ticamente | âŒ No se mapean |
| **Estado** | **ACTIVO** | **PREPARADO** |

---

## Diagrama Completo: Flujo de Suscripciones

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CICLO DE VIDA DE UNA SUSCRIPCIÃ“N                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

     SUPERADMIN                          NEXO TEAM (org_id=1)                    ORGANIZACIÃ“N (org 2, 3...)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚          â”‚                        â”‚                    â”‚                   â”‚                    â”‚
    â”‚ Configuraâ”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º    â”‚  PLANES NEXO       â”‚                   â”‚                    â”‚
    â”‚ Entitle- â”‚  1. Define planes      â”‚                    â”‚                   â”‚                    â”‚
    â”‚ ments    â”‚     con lÃ­mites        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                   â”‚                    â”‚
    â”‚          â”‚     y mÃ³dulos          â”‚  â”‚ Plan Trial  â”‚   â”‚                   â”‚                    â”‚
    â”‚          â”‚                        â”‚  â”‚ $0/mes      â”‚   â”‚                   â”‚                    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚  â”‚ 3 usuarios  â”‚   â”‚                   â”‚                    â”‚
         â”‚                              â”‚  â”‚ max_hard: 3 â”‚   â”‚                   â”‚                    â”‚
         â”‚                              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                   â”‚                    â”‚
         â”‚                              â”‚                    â”‚                   â”‚                    â”‚
         â”‚                              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                   â”‚                    â”‚
         â–¼                              â”‚  â”‚ Plan Pro    â”‚   â”‚                   â”‚                    â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚  â”‚ $249/mes    â”‚   â”‚                   â”‚                    â”‚
    â”‚ /super-  â”‚                        â”‚  â”‚ 5 usuarios  â”‚   â”‚                   â”‚                    â”‚
    â”‚ admin/   â”‚                        â”‚  â”‚ +$49/extra  â”‚   â”‚                   â”‚                    â”‚
    â”‚ entitle- â”‚                        â”‚  â”‚ max_hard: âˆ â”‚   â”‚                   â”‚                    â”‚
    â”‚ ments    â”‚                        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                   â”‚                    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚                    â”‚                   â”‚                    â”‚
                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                                                  â”‚ 2. Usuario se registra
                                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  REGISTRO Y TRIAL AUTOMÃTICO                                                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                                     â”‚
â”‚   Usuario â”€â”€â–º POST /auth/registro â”€â”€â–º DogfoodingService.vincularOrganizacionComoCliente()          â”‚
â”‚                                                  â”‚                                                  â”‚
â”‚                                                  â–¼                                                  â”‚
â”‚                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚                                        â”‚ 1. Crea Cliente en  â”‚                                      â”‚
â”‚                                        â”‚    org 1 (Nexo)     â”‚                                      â”‚
â”‚                                        â”‚    con org_vincu-   â”‚                                      â”‚
â”‚                                        â”‚    lada_id = org_x  â”‚                                      â”‚
â”‚                                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                      â”‚
â”‚                                        â”‚ 2. Crea SuscripciÃ³n â”‚                                      â”‚
â”‚                                        â”‚    estado: 'trial'  â”‚                                      â”‚
â”‚                                        â”‚    plan: Trial      â”‚                                      â”‚
â”‚                                        â”‚    fin_trial: +14d  â”‚                                      â”‚
â”‚                                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                      â”‚
â”‚                                        â”‚ 3. Activa mÃ³dulos   â”‚                                      â”‚
â”‚                                        â”‚    base en la org   â”‚                                      â”‚
â”‚                                        â”‚    modulos_activos: â”‚                                      â”‚
â”‚                                        â”‚    { core: true }   â”‚                                      â”‚
â”‚                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚                                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                                                  â”‚ 3. Usuario decide contratar
                                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CHECKOUT Y ACTIVACIÃ“N                                                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                                     â”‚
â”‚   Usuario â”€â”€â–º Selecciona Plan Pro â”€â”€â–º POST /checkout/iniciar                                        â”‚
â”‚                                                  â”‚                                                  â”‚
â”‚                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚                                        â”‚ PlatformBilling â”‚                                          â”‚
â”‚                                        â”‚    Strategy     â”‚                                          â”‚
â”‚                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚                                                 â”‚                                                   â”‚
â”‚                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚                                        â”‚  MercadoPago    â”‚                                          â”‚
â”‚                                        â”‚  Preapproval    â”‚                                          â”‚
â”‚                                        â”‚  API            â”‚                                          â”‚
â”‚                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚                                                 â”‚                                                   â”‚
â”‚                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚                                        â”‚ Redirect a MP   â”‚                                          â”‚
â”‚                                        â”‚ para pago       â”‚                                          â”‚
â”‚                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚                                                 â”‚                                                   â”‚
â”‚   Usuario completa pago en MercadoPago          â”‚                                                   â”‚
â”‚                                                 â–¼                                                   â”‚
â”‚                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚                                        â”‚    WEBHOOK      â”‚                                          â”‚
â”‚                                        â”‚  authorized o   â”‚                                          â”‚
â”‚                                        â”‚  payment.createdâ”‚                                          â”‚
â”‚                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚                                                 â”‚                                                   â”‚
â”‚                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚                                        â”‚ actualizarOrgVinculadaAl-    â”‚                             â”‚
â”‚                                        â”‚ Activar()                    â”‚                             â”‚
â”‚                                        â”‚                              â”‚                             â”‚
â”‚                                        â”‚ 1. estado: 'activa'          â”‚                             â”‚
â”‚                                        â”‚ 2. Mapea features â†’ mÃ³dulos: â”‚                             â”‚
â”‚                                        â”‚    ['agendamiento', 'pos']   â”‚                             â”‚
â”‚                                        â”‚    â†’                         â”‚                             â”‚
â”‚                                        â”‚    { agendamiento: true,     â”‚                             â”‚
â”‚                                        â”‚      pos: true }             â”‚                             â”‚
â”‚                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                                                  â”‚ 4. OrganizaciÃ³n usa Nexo
                                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USO Y VERIFICACIÃ“N DE LÃMITES                                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                                     â”‚
â”‚   Admin org â”€â”€â–º Crear Usuario â”€â”€â–º LimitesHelper.verificarLimiteOLanzar('usuarios')                 â”‚
â”‚                                                  â”‚                                                  â”‚
â”‚                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚                                        â”‚ RLSContextManager.withBypass()          â”‚                  â”‚
â”‚                                        â”‚                                         â”‚                  â”‚
â”‚                                        â”‚ Busca suscripciÃ³n donde:                â”‚                  â”‚
â”‚                                        â”‚ cliente.organizacion_vinculada_id = X   â”‚                  â”‚
â”‚                                        â”‚                                         â”‚                  â”‚
â”‚                                        â”‚ Obtiene lÃ­mites del plan:               â”‚                  â”‚
â”‚                                        â”‚ - usuarios_incluidos: 5                 â”‚                  â”‚
â”‚                                        â”‚ - precio_usuario_adicional: $49         â”‚                  â”‚
â”‚                                        â”‚ - max_usuarios_hard: NULL               â”‚                  â”‚
â”‚                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                 â”‚                                                   â”‚
â”‚                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚                                        â”‚ Â¿Excede lÃ­mite? â”‚                                          â”‚
â”‚                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚                                                 â”‚                                                   â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚                    â–¼                            â–¼                            â–¼                      â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚           â”‚ usuarios < 5  â”‚          â”‚ usuarios >= 5 y   â”‚         â”‚ usuarios >= max   â”‚            â”‚
â”‚           â”‚               â”‚          â”‚ hay precio_extra  â”‚         â”‚ (hard limit)      â”‚            â”‚
â”‚           â”‚ âœ… Permitido  â”‚          â”‚                   â”‚         â”‚                   â”‚            â”‚
â”‚           â”‚               â”‚          â”‚ âœ… Permitido      â”‚         â”‚ âŒ Bloqueado      â”‚            â”‚
â”‚           â”‚               â”‚          â”‚ Se cobra extra    â”‚         â”‚ Error 403         â”‚            â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                                                  â”‚ 5. Tracking y cobro mensual
                                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SEAT-BASED BILLING: COBRO POR USUARIOS ADICIONALES                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                                     â”‚
â”‚   DIARIO (23:55)                               MENSUAL (06:00)                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚   â”‚ Job: registrar-  â”‚                         â”‚ Job: procesar-cobros            â”‚                  â”‚
â”‚   â”‚ uso-usuarios     â”‚                         â”‚                                 â”‚                  â”‚
â”‚   â”‚                  â”‚                         â”‚ 1. Obtener max_usuarios del     â”‚                  â”‚
â”‚   â”‚ INSERT INTO      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚    perÃ­odo (de uso_usuarios)    â”‚                  â”‚
â”‚   â”‚ uso_usuarios_org â”‚                         â”‚                                 â”‚                  â”‚
â”‚   â”‚ (org_id, fecha,  â”‚                         â”‚ 2. Calcular:                    â”‚                  â”‚
â”‚   â”‚  usuarios_act)   â”‚                         â”‚    extras = max - incluidos     â”‚                  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚    ajuste = extras Ã— $49        â”‚                  â”‚
â”‚                                                â”‚                                 â”‚                  â”‚
â”‚   Ejemplo:                                     â”‚ 3. total = $249 + ajuste        â”‚                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚                                 â”‚                  â”‚
â”‚   â”‚ Fecha   â”‚ Usuarios â”‚                       â”‚ 4. Cobrar vÃ­a MercadoPago       â”‚                  â”‚
â”‚   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚   â”‚ Ene 01  â”‚    5     â”‚                                                                            â”‚
â”‚   â”‚ Ene 05  â”‚    6     â”‚  â† ContratÃ³ 1 extra                                                        â”‚
â”‚   â”‚ Ene 15  â”‚    8     â”‚  â† ContratÃ³ 2 mÃ¡s                                                          â”‚
â”‚   â”‚ Ene 20  â”‚    7     â”‚  â† DesactivÃ³ 1                                                             â”‚
â”‚   â”‚ Ene 31  â”‚    7     â”‚                                                                            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                            â”‚
â”‚                                                                                                     â”‚
â”‚   MAX del perÃ­odo = 8                                                                               â”‚
â”‚   Usuarios incluidos = 5                                                                            â”‚
â”‚   Usuarios extra = 8 - 5 = 3                                                                        â”‚
â”‚   Ajuste = 3 Ã— $49 = $147                                                                           â”‚
â”‚   TOTAL FEBRERO = $249 + $147 = $396                                                                â”‚
â”‚                                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Entitlements: CÃ³mo Funcionan los LÃ­mites

### ConfiguraciÃ³n desde SuperAdmin

Los lÃ­mites y features de cada plan se configuran desde `/superadmin/entitlements-plataforma` (solo SuperAdmin):

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Entitlements de Plataforma                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PLAN       â”‚ MENSUAL  â”‚ SEMESTRAL â”‚ USUARIOS          â”‚ MÃ“DULOS   â”‚ ESTADO    â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ Plan Trial â”‚ $0       â”‚ -         â”‚ 3 (mÃ¡x 3)         â”‚ 3 mÃ³dulos â”‚ Activo    â”‚
â”‚ Plan Pro   â”‚ $249     â”‚ $1,200    â”‚ 5 (+$49.00/extra) â”‚ 9 mÃ³dulos â”‚ Activo    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Tipos de ConfiguraciÃ³n de Usuarios

| ConfiguraciÃ³n | Ejemplo | Comportamiento |
|---------------|---------|----------------|
| **Hard Limit** | `usuarios_incluidos: 3, max_usuarios_hard: 3` | No puede agregar mÃ¡s de 3. Error 403. |
| **Soft Limit** | `usuarios_incluidos: 5, precio_usuario_adicional: $49` | Puede agregar ilimitados, cobra $49/extra |
| **Ilimitado** | `usuarios_incluidos: 100, max_usuarios_hard: null, precio_extra: null` | Todos incluidos sin cargo extra |

### Ejemplo: Plan Trial vs Plan Pro

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PLAN TRIAL                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  usuarios_incluidos: 3                                          â”‚
â”‚  max_usuarios_hard: 3                                           â”‚
â”‚  precio_usuario_adicional: NULL                                 â”‚
â”‚                                                                 â”‚
â”‚  Resultado:                                                     â”‚
â”‚  - OrganizaciÃ³n puede tener MÃXIMO 3 usuarios                   â”‚
â”‚  - Al intentar crear el 4to: âŒ Error "LÃ­mite alcanzado"        â”‚
â”‚  - SoluciÃ³n: Cambiar a Plan Pro                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PLAN PRO                                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  usuarios_incluidos: 5                                          â”‚
â”‚  max_usuarios_hard: NULL (ilimitado)                            â”‚
â”‚  precio_usuario_adicional: $49                                  â”‚
â”‚                                                                 â”‚
â”‚  Resultado:                                                     â”‚
â”‚  - OrganizaciÃ³n puede agregar ILIMITADOS usuarios               â”‚
â”‚  - Primeros 5 incluidos en $249                                 â”‚
â”‚  - Del 6 en adelante: +$49/usuario al mes                       â”‚
â”‚  - NO necesita cambiar de plan para crecer                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Â¿CuÃ¡ndo Crear un Plan Nuevo vs Usar Seat-Based?

| Escenario | SoluciÃ³n | Ejemplo |
|-----------|----------|---------|
| Cliente quiere mÃ¡s usuarios | **Seat-Based** (automÃ¡tico) | Pro: 5 incluidos + $49/extra |
| Cliente quiere precio fijo con muchos usuarios | **Nuevo Plan** | Enterprise: 50 usuarios por $999 |
| Cliente quiere diferentes mÃ³dulos | **Nuevo Plan** | Plan "Solo POS" sin agendamiento |
| Cliente quiere descuento por volumen | **Nuevo Plan** | Enterprise: usuarios ilimitados |

---

## SeparaciÃ³n: Billing vs Entitlements

### Conceptos Clave

| Concepto | DescripciÃ³n | QuiÃ©n lo controla |
|----------|-------------|-------------------|
| **Billing** | Cobrar dinero recurrentemente | MÃ³dulo de suscripciones |
| **Entitlements** | QuÃ© puede hacer el cliente con lo que comprÃ³ | SuperAdmin vÃ­a `/superadmin/entitlements-plataforma` |

### AplicaciÃ³n en Nexo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  NEXO (Platform Billing)                                        â”‚
â”‚  â”œâ”€â”€ Billing: Cobra $249/mes a organizaciones                   â”‚
â”‚  â””â”€â”€ Entitlements: Nexo CONTROLA lÃ­mites y mÃ³dulos              â”‚
â”‚       â””â”€â”€ LimitesHelper.js verifica usuarios, sucursales        â”‚
â”‚       â””â”€â”€ FEATURE_TO_MODULO activa mÃ³dulos                      â”‚
â”‚                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚                                                                 â”‚
â”‚  GIMNASIO (Customer Billing - usando mÃ³dulo de Nexo)            â”‚
â”‚  â”œâ”€â”€ Billing: Cobra $500/mes membresÃ­as â† Nexo hace esto        â”‚
â”‚  â””â”€â”€ Entitlements: Â¿Acceso a piscina? â† Nexo NO hace esto       â”‚
â”‚       â””â”€â”€ El gimnasio lo gestiona manualmente                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Campos en planes_suscripcion_org

```sql
planes_suscripcion_org:
  -- BILLING (todos los planes)
  codigo, nombre, descripcion
  precio_mensual, precio_trimestral, precio_semestral, precio_anual  -- Multi-periodo completo
  moneda, dias_trial

  -- ENTITLEMENTS (solo planes de Nexo, org_id = 1)
  limites: { usuarios: 5, sucursales: 3 }  -- Verificados por LimitesHelper
  features: ['agendamiento', 'inventario'] -- Mapeados a modulos_activos
  usuarios_incluidos: 5
  precio_usuario_adicional: 49.00
  max_usuarios_hard: NULL
```

### Precios Multi-Periodo

| PerÃ­odo | Campo BD | CÃ¡lculo si NULL |
|---------|----------|-----------------|
| Mensual | `precio_mensual` | Requerido (default 0) |
| Trimestral | `precio_trimestral` | `precio_mensual Ã— 3` |
| **Semestral** | `precio_semestral` | `precio_mensual Ã— 6` |
| Anual | `precio_anual` | `precio_mensual Ã— 12` |

El checkout (`checkout.controller.js`) usa el precio configurado si existe, o calcula automÃ¡ticamente basÃ¡ndose en el precio mensual.

**Nota**: Para Customer Billing, los campos de entitlements se **ignoran** o se usan como texto descriptivo en UI.

---

## Estados de SuscripciÃ³n

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  trial   â”‚  PerÃ­odo de prueba
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                         â”‚
                    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚pendiente_pagoâ”‚  Checkout iniciado
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”Œâ”€â”€â”€â”€â”€â”‚   activa    â”‚â”€â”€â”€â”€â”€â”
              â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
              â–¼                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚pausada â”‚              â”‚grace_period â”‚  7 dÃ­as solo lectura
         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
              â”‚                         â”‚
              â–¼                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚canceladaâ”‚             â”‚ suspendidaâ”‚  Bloqueado
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Niveles de Acceso

| Estado | Acceso | UX |
|--------|--------|-----|
| `trial`, `activa`, `pendiente_pago` | âœ… Completo | Normal |
| `grace_period`, `vencida` | âš ï¸ Solo lectura | Banner urgente |
| `pausada`, `suspendida`, `cancelada` | âŒ Bloqueado | Redirect `/planes` |

### Bypasses

- `organizacion_id === 1` (Nexo Team)
- `nivel_jerarquia >= 100` (SuperAdmin)
- Rutas: `/auth/*`, `/planes/*`, `/checkout/*`, `/webhooks`

---

## Flujo Platform Billing (Nexo â†’ Organizaciones)

### 1. Registro de OrganizaciÃ³n

```javascript
// Al crear organizaciÃ³n, automÃ¡ticamente:
DogfoodingService.vincularOrganizacionComoCliente(org)
  â”œâ”€ Crear cliente en Nexo Team (org_id=1)
  â”‚   â””â”€ organizacion_vinculada_id = org.id
  â”œâ”€ Crear suscripciÃ³n Trial
  â”‚   â””â”€ estado: 'trial', es_trial: true
  â””â”€ Activar mÃ³dulos base
      â””â”€ org.modulos_activos = { core: true }
```

### 2. Checkout y ActivaciÃ³n

```
Usuario (org 2) â”€â”€â–º Selecciona plan Pro
                          â”‚
                    POST /checkout/iniciar
                          â”‚
                    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
                    â”‚ Strategy: â”‚
                    â”‚ Platform  â”‚
                    â”‚ Billing   â”‚
                    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                          â”‚
            vendorId = NEXO_TEAM_ORG_ID (1)
            clienteId = cliente vinculado a org 2
                          â”‚
                    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
                    â”‚MercadoPagoâ”‚
                    â”‚Preapprovalâ”‚
                    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                          â”‚
                    Redirect a MP
                          â”‚
                    Pago completado
                          â”‚
                    Webhook â”€â”€â–º actualizarOrgVinculadaAlActivar()
                          â”‚
                    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Mapear features â†’     â”‚
                    â”‚ modulos_activos       â”‚
                    â”‚                       â”‚
                    â”‚ ['agendamiento'] â†’    â”‚
                    â”‚ { agendamiento: true }â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. VerificaciÃ³n de LÃ­mites

```javascript
// Antes de crear usuario en org 2
LimitesHelper.verificarLimiteOLanzar(orgId=2, 'usuarios', 1)
  â”‚
  â”œâ”€ Buscar suscripciÃ³n de la org
  â”‚   â””â”€ Â¡PROBLEMA! La suscripciÃ³n estÃ¡ en org 1 (Nexo)
  â”‚
  â””â”€ SOLUCIÃ“N: RLSContextManager.withBypass()
      â””â”€ Busca: suscripciones_org.cliente.organizacion_vinculada_id = 2
      â””â”€ Obtiene lÃ­mites del plan
      â””â”€ Verifica contra uso actual
```

---

## Seat-Based Billing Detallado

### Tracking Diario (23:55)

```javascript
// Job: registrar-uso-usuarios.job.js
// Guarda snapshot diario de usuarios activos por org
INSERT INTO uso_usuarios_org (organizacion_id, fecha, usuarios_activos)
SELECT organizacion_id, CURRENT_DATE, COUNT(*)
FROM usuarios WHERE activo = true
GROUP BY organizacion_id;
```

### Tipos de LÃ­mites

| Tipo | Comportamiento | Ejemplo |
|------|----------------|---------|
| **Hard Limit** | Bloquea creaciÃ³n | Trial: mÃ¡x 3 usuarios |
| **Soft Limit** | Permite con cargo | Pro: $49/usuario extra |

### CÃ¡lculo de Cobro Mensual

```
usuarios_max_periodo = MAX(usuarios_activos) durante el perÃ­odo
usuarios_extra = usuarios_max_periodo - usuarios_incluidos
ajuste = usuarios_extra Ã— precio_usuario_extra
total = precio_base + ajuste

Ejemplo con Plan Pro:
- MÃ¡ximo usuarios en enero: 8
- Incluidos: 5
- Extra: 8 - 5 = 3
- Precio base: $249
- Ajuste: 3 Ã— $49 = $147
- TOTAL: $249 + $147 = $396
```

---

## Proceso de Cobro MercadoPago (AnÃ¡lisis Detallado)

### CÃ³mo Funciona MercadoPago Preapproval

Con la API de Preapproval, **MercadoPago procesa los cobros automÃ¡ticamente**. Nosotros solo recibimos webhooks notificÃ¡ndonos de cada evento.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     CICLO DE VIDA PREAPPROVAL                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  1. CREACIÃ“N (Nosotros)                                                     â”‚
â”‚     â””â”€> Nexo crea preapproval con: monto, frecuencia, auto_recurring: true  â”‚
â”‚                                                                             â”‚
â”‚  2. AUTORIZACIÃ“N (Usuario)                                                  â”‚
â”‚     â””â”€> Usuario autoriza en checkout de MP                                  â”‚
â”‚     â””â”€> MP envÃ­a webhook: subscription_preapproval (status: authorized)     â”‚
â”‚                                                                             â”‚
â”‚  3. COBROS AUTOMÃTICOS (MercadoPago)                                        â”‚
â”‚     â””â”€> MP ejecuta cobro segÃºn frecuencia configurada                       â”‚
â”‚     â””â”€> MP envÃ­a webhook: subscription_authorized_payment                   â”‚
â”‚     â””â”€> Se repite cada mes/perÃ­odo AUTOMÃTICAMENTE                          â”‚
â”‚                                                                             â”‚
â”‚  4. CANCELACIÃ“N/PAUSA                                                       â”‚
â”‚     â””â”€> Usuario o negocio cancela                                           â”‚
â”‚     â””â”€> MP envÃ­a webhook: subscription_preapproval (status: cancelled)      â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Webhooks que Procesamos

| Webhook | Trigger | AcciÃ³n en Nexo |
|---------|---------|----------------|
| `subscription_preapproval` (authorized) | Usuario autoriza suscripciÃ³n | Activar suscripciÃ³n, mapear mÃ³dulos |
| `subscription_preapproval` (cancelled) | Usuario/negocio cancela | Cancelar suscripciÃ³n |
| `subscription_preapproval` (paused) | Usuario pausa | Pausar suscripciÃ³n |
| `subscription_authorized_payment` | MP procesa cobro recurrente | Registrar pago, actualizar fecha_proximo_cobro |

### Rol del Job `procesar-cobros.job.js`

**IMPORTANTE**: Este job estÃ¡ diseÃ±ado para escenarios donde **nosotros iniciamos el cobro**, no MercadoPago:

| Gateway | Â¿Usa el job? | RazÃ³n |
|---------|--------------|-------|
| MercadoPago Preapproval | âŒ **NO** | MP cobra automÃ¡ticamente |
| Stripe (off_session) | âœ… **SÃ** | Debemos crear PaymentIntent |
| Manual | âœ… **SÃ** | EnvÃ­a recordatorio de pago |

### Seat-Based Billing con MercadoPago Preapproval

El preapproval tiene un `transaction_amount` fijo. Para cobrar usuarios adicionales:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  AJUSTE DINÃMICO DE MONTO EN PREAPPROVAL                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  MES 1: Plan Pro con 5 usuarios incluidos                                   â”‚
â”‚  â””â”€> Preapproval creado con $249/mes                                        â”‚
â”‚  â””â”€> MP cobra $249 automÃ¡ticamente âœ…                                       â”‚
â”‚                                                                             â”‚
â”‚  MES 2: Org tiene 8 usuarios (3 extra Ã— $49 = $147)                        â”‚
â”‚                                                                             â”‚
â”‚  ESTRATEGIA: Actualizar preapproval ANTES del cobro                        â”‚
â”‚  â”œâ”€> 1. Job detecta 3 usuarios extra (dÃ­a 28-30)                           â”‚
â”‚  â”œâ”€> 2. PUT /preapproval/{id} â†’ transaction_amount = $396                  â”‚
â”‚  â””â”€> 3. (Opcional) Cobro adicional prorateado del mes actual               â”‚
â”‚                                                                             â”‚
â”‚  MES 3: MP cobra $396 automÃ¡ticamente âœ…                                    â”‚
â”‚  (Ya incluye los 3 usuarios extra)                                          â”‚
â”‚                                                                             â”‚
â”‚  MES 4: Org reduce a 6 usuarios (1 extra Ã— $49 = $49)                      â”‚
â”‚  â”œâ”€> Job detecta cambio                                                     â”‚
â”‚  â””â”€> PUT /preapproval/{id} â†’ transaction_amount = $298                      â”‚
â”‚                                                                             â”‚
â”‚  MES 5: MP cobra $298 automÃ¡ticamente âœ…                                    â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Estrategia Recomendada para Seat-Based

| Paso | Timing | AcciÃ³n |
|------|--------|--------|
| 1 | Diario (23:55) | Job `registrar-uso-usuarios` guarda snapshot |
| 2 | Antes del cobro (~dÃ­a 28) | Job calcula MAX usuarios del perÃ­odo |
| 3 | Antes del cobro | Si hay diferencia, **actualiza preapproval** con nuevo monto |
| 4 | DÃ­a de cobro | MercadoPago cobra el monto actualizado automÃ¡ticamente |
| 5 | (Opcional) | Cobro adicional si el cambio fue a mitad del mes |

**Respuesta clave**: Si actualizamos el preapproval **ANTES** de que MercadoPago procese el siguiente cobro, el cobro ya vendrÃ¡ con el monto ajustado.

### Diagrama: Flujo de Cobro Recurrente

```mermaid
sequenceDiagram
    participant ORG as OrganizaciÃ³n
    participant NEXO as Nexo Backend
    participant MP as MercadoPago
    participant WH as Webhook Handler

    Note over ORG,MP: MES 1: ActivaciÃ³n

    ORG->>NEXO: Selecciona Plan Pro ($249)
    NEXO->>MP: POST /preapproval (auto_recurring: true)
    MP-->>ORG: Redirect a checkout
    ORG->>MP: Autoriza pago
    MP->>WH: webhook: subscription_preapproval (authorized)
    WH->>NEXO: Activar suscripciÃ³n + mÃ³dulos

    Note over ORG,MP: MES 2: Cobro AutomÃ¡tico

    MP->>MP: Procesa cobro automÃ¡tico ($249)
    MP->>WH: webhook: subscription_authorized_payment
    WH->>NEXO: Registrar pago + actualizar fecha_proximo_cobro
    NEXO-->>ORG: Email confirmaciÃ³n

    Note over ORG,MP: MES 3: Org agregÃ³ usuarios

    rect rgb(255, 245, 200)
        Note right of NEXO: DÃ­a 28: Job detecta 8 usuarios
        NEXO->>NEXO: Calcular: (8-5) Ã— $49 = $147
        NEXO->>MP: PUT /preapproval â†’ $396
    end

    MP->>MP: Procesa cobro automÃ¡tico ($396)
    MP->>WH: webhook: subscription_authorized_payment
    WH->>NEXO: Registrar pago de $396
```

### Job de Ajuste de Preapproval (âœ… Implementado)

```javascript
// backend/app/modules/suscripciones-negocio/jobs/ajustar-preapproval.job.js
// Se ejecuta: DÃ­a 28 de cada mes a las 20:00 (antes del cobro de MP)

class AjustarPreapprovalJob {
    static async ejecutar() {
        // 1. Obtener suscripciones MP activas con precio_usuario_adicional
        const suscripciones = await this._obtenerSuscripcionesParaAjustar();

        for (const suscripcion of suscripciones) {
            // 2. Calcular usuarios extra usando usuarios_max_periodo
            const usuariosExtra = Math.max(0, usuariosMax - usuariosIncluidos);
            const nuevoMonto = precioMensual + (usuariosExtra * precioUsuarioExtra);

            // 3. Si el monto cambiÃ³, actualizar preapproval en MP
            if (Math.abs(montoActualMP - nuevoMonto) >= 0.01) {
                await mpService.actualizarMontoPreapproval(preapprovalId, nuevoMonto, moneda);

                // 4. Registrar ajuste en ajustes_facturacion_org
                await UsageTrackingService.registrarAjusteUsuarios({...});
            }
        }
    }
}
```

### Resumen del Proceso de Cobro

| Pregunta | Respuesta |
|----------|-----------|
| Â¿MP procesa cobros automÃ¡ticamente? | âœ… SÃ­, con preapproval `status: authorized` |
| Â¿QuÃ© webhook recibimos al cobrar? | `subscription_authorized_payment` |
| Â¿Necesitamos el job diario para MP? | âŒ No para el cobro, âœ… SÃ­ para ajustar monto |
| Â¿El monto se ajusta automÃ¡ticamente? | âŒ No, debemos actualizar preapproval antes del cobro |
| Â¿El siguiente mes cobra ajustado? | âœ… SÃ­, si actualizamos el preapproval a tiempo |

---

## Sistema de FacturaciÃ³n por Usuarios (Seat-Based Billing) âœ…

El sistema permite cobrar automÃ¡ticamente por usuarios adicionales que excedan los incluidos en el plan.

### Flujo AutomÃ¡tico Completo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SEAT-BASED BILLING - FLUJO COMPLETO                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  1. TRACKING DIARIO (Cron 23:55)                                                   â”‚
â”‚     â””â”€> RegistrarUsoUsuariosJob                                                    â”‚
â”‚         â€¢ Cuenta usuarios activos por organizaciÃ³n                                  â”‚
â”‚         â€¢ Actualiza suscripciones_org.usuarios_max_periodo si hay nuevo mÃ¡ximo     â”‚
â”‚                                                                                     â”‚
â”‚  2. AJUSTE DE PREAPPROVAL (Cron dÃ­a 28, 20:00)                                     â”‚
â”‚     â””â”€> AjustarPreapprovalJob                                                      â”‚
â”‚         â€¢ Calcula: usuariosExtra = usuarios_max_periodo - usuarios_incluidos        â”‚
â”‚         â€¢ Calcula: nuevoMonto = precio_mensual + (usuariosExtra Ã— precio_adicional) â”‚
â”‚         â€¢ Actualiza transaction_amount en MercadoPago via API                       â”‚
â”‚         â€¢ Registra ajuste en ajustes_facturacion_org                               â”‚
â”‚                                                                                     â”‚
â”‚  3. COBRO AUTOMÃTICO (PrÃ³ximo ciclo de MP)                                         â”‚
â”‚     â””â”€> MercadoPago cobra el monto ajustado automÃ¡ticamente                        â”‚
â”‚     â””â”€> Webhook notifica y registramos el pago                                     â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Campos Relevantes en Base de Datos

| Tabla | Campo | DescripciÃ³n |
|-------|-------|-------------|
| `suscripciones_org` | `usuarios_max_periodo` | MÃ¡ximo de usuarios activos durante el perÃ­odo actual |
| `planes_suscripcion_org` | `usuarios_incluidos` | Usuarios sin costo adicional en el plan |
| `planes_suscripcion_org` | `precio_usuario_adicional` | Precio por cada usuario que exceda el lÃ­mite |
| `ajustes_facturacion_org` | - | Historial de ajustes por usuarios adicionales |

### Jobs Relacionados

| Job | Archivo | Horario | FunciÃ³n |
|-----|---------|---------|---------|
| Registrar uso usuarios | `registrar-uso-usuarios.job.js` | 23:55 diario | Trackea usuarios activos y actualiza `usuarios_max_periodo` |
| Ajustar preapproval | `ajustar-preapproval.job.js` | DÃ­a 28, 20:00 | Actualiza `transaction_amount` en MP antes del cobro |

### DecisiÃ³n de DiseÃ±o: No Cobro Inmediato

El sistema actual **no realiza cobros adicionales inmediatos** cuando se agregan usuarios a mitad de mes. En su lugar:

1. **Tracking continuo**: Se registra el mÃ¡ximo de usuarios durante el perÃ­odo
2. **Ajuste mensual**: El dÃ­a 28 se actualiza el preapproval con el monto total
3. **Cobro integrado**: MercadoPago cobra el monto ajustado en el prÃ³ximo ciclo

**RazÃ³n**: Simplifica la facturaciÃ³n y evita mÃºltiples cobros pequeÃ±os que pueden generar fricciÃ³n con el usuario.

---

## IntegraciÃ³n MercadoPago

### Arquitectura de Cuentas de Prueba

```
CUENTA REAL (principal)
  â””â”€â”€ Panel Developers â†’ Test Users
          â”‚
          â”œâ”€â”€â–º CUENTA VENDEDOR (Test User)
          â”‚    â€¢ Recibe pagos
          â”‚    â€¢ Access Token: APP_USR-xxx
          â”‚
          â””â”€â”€â–º CUENTA COMPRADOR (Test User)
               â€¢ Realiza pagos
               â€¢ Email: test_user_xxx@testuser.com
```

### ConfiguraciÃ³n del Conector

| Campo | Sandbox | Production |
|-------|---------|------------|
| `entorno` | `sandbox` | `production` |
| `access_token` | De cuenta vendedor prueba | De cuenta real |
| `test_payer_email` | **Requerido** | No se usa |
| `webhook_secret` | Secret del webhook | Secret del webhook |

### Tarjetas de Prueba

| Tarjeta | NÃºmero | CVV | Vencimiento |
|---------|--------|-----|-------------|
| Mastercard | 5474 9254 3267 0366 | 123 | 11/27 |
| Visa | 4509 9535 6623 3704 | 123 | 11/27 |
| Amex | 3711 803032 57522 | 1234 | 11/27 |

---

## Jobs Programados

| Hora | Job | FunciÃ³n |
|------|-----|---------|
| 06:00 | `procesar-cobros` | Cobros automÃ¡ticos |
| 07:00 | `verificar-trials` | Expira trials vencidos |
| 08:00 | `procesar-dunning` | Grace period â†’ SuspensiÃ³n |
| 20:00 dÃ­a 28 | `ajustar-preapproval` | Actualiza monto MP para usuarios extra |
| 23:55 | `registrar-uso-usuarios` | Snapshot usuarios activos |
| */5min | `polling-suscripciones` | Fallback si webhooks fallan |
| */hora :30 | `monitorear-webhooks` | Alertas de webhooks fallidos |

---

## Endpoints Principales

```bash
# Suscripciones
GET    /suscripciones/mi-suscripcion              # Ver plan actual
GET    /suscripciones/mi-suscripcion/calcular-prorrateo?nuevo_plan_id=X
POST   /suscripciones/mi-plan/cambiar             # Cambiar plan
PATCH  /suscripciones/:id/pausar
POST   /suscripciones/:id/cancelar

# Checkout
POST   /checkout/iniciar                           # Platform Billing
POST   /checkout/publico/crear-suscripcion         # Checkout sin auth
GET    /checkout/link/:token

# Uso (Seat-based)
GET    /uso/resumen
GET    /uso/proyeccion
GET    /uso/verificar-limite

# Entitlements (SuperAdmin)
GET    /entitlements/planes                        # Lista planes Nexo con entitlements
PUT    /entitlements/planes/:id                    # Actualiza entitlements de un plan

# MÃ©tricas
GET    /metricas/dashboard
GET    /metricas/mrr
GET    /metricas/churn
```

---

## Tablas Principales

| Tabla | PropÃ³sito | Multi-tenant |
|-------|-----------|--------------|
| `planes_suscripcion_org` | CatÃ¡logo de planes (precios mensual/trimestral/semestral/anual) | âœ… Por org |
| `suscripciones_org` | Suscripciones activas | âœ… Por org |
| `pagos_suscripcion` | Historial de pagos | âœ… Por org |
| `uso_usuarios_org` | Tracking diario | âœ… Por org |
| `conectores_pago_org` | Gateways de pago | âœ… Por org |
| `cupones_suscripcion` | CÃ³digos de descuento | âœ… Por org |
| `webhooks_suscripcion` | Log de webhooks | âœ… Por org |
| `ajustes_facturacion_org` | Log de ajustes seat-based | âœ… Por org |

---

## Archivos Clave

```
backend/app/modules/suscripciones-negocio/
â”œâ”€â”€ strategies/
â”‚   â”œâ”€â”€ BillingStrategy.js           # Interfaz base
â”‚   â”œâ”€â”€ PlatformBillingStrategy.js   # Nexo â†’ Orgs (ACTIVO)
â”‚   â””â”€â”€ CustomerBillingStrategy.js   # Org â†’ Clientes (PREPARADO)
â”œâ”€â”€ controllers/
â”‚   â”œâ”€â”€ checkout.controller.js       # Flujo de pago
â”‚   â”œâ”€â”€ suscripciones.controller.js  # CRUD suscripciones
â”‚   â”œâ”€â”€ entitlements.controller.js   # âœ… NUEVO - GestiÃ³n entitlements
â”‚   â””â”€â”€ webhooks.controller.js       # Procesamiento webhooks
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ entitlements.routes.js       # âœ… NUEVO - Rutas SuperAdmin
â”‚   â””â”€â”€ ...
â”œâ”€â”€ schemas/
â”‚   â”œâ”€â”€ entitlements.schemas.js      # âœ… NUEVO - ValidaciÃ³n Joi
â”‚   â””â”€â”€ ...
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ suscripciones.model.js       # LÃ³gica de negocio
â”‚   â””â”€â”€ planes.model.js              # GestiÃ³n de planes
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ mercadopago.service.js       # Wrapper MP multi-tenant
â”‚   â”œâ”€â”€ usage-tracking.service.js    # Seat-based billing
â”‚   â””â”€â”€ cobro.service.js             # Procesamiento de cobros
â””â”€â”€ jobs/
    â”œâ”€â”€ procesar-cobros.job.js       # 06:00 diario
    â”œâ”€â”€ verificar-trials.job.js      # 07:00 diario
    â”œâ”€â”€ ajustar-preapproval.job.js   # âœ… DÃ­a 28, 20:00 - Seat-based billing
    â”œâ”€â”€ registrar-uso-usuarios.job.js # 23:55 diario
    â””â”€â”€ polling-suscripciones.job.js # Cada 5 min

backend/app/
â”œâ”€â”€ utils/helpers/LimitesHelper.js   # VerificaciÃ³n de lÃ­mites
â”œâ”€â”€ config/constants.js              # FEATURE_TO_MODULO, estados
â”œâ”€â”€ services/dogfoodingService.js    # VinculaciÃ³n org â†’ cliente
â””â”€â”€ middleware/suscripcionActiva.js  # Guard de acceso

frontend/src/
â”œâ”€â”€ pages/superadmin/
â”‚   â””â”€â”€ EntitlementsPlataforma.jsx   # âœ… NUEVO - PÃ¡gina principal
â”œâ”€â”€ components/superadmin/
â”‚   â””â”€â”€ EntitlementsFormDrawer.jsx   # âœ… NUEVO - Drawer ediciÃ³n
â””â”€â”€ hooks/superadmin/
    â””â”€â”€ useEntitlements.js           # âœ… NUEVO - React Query hooks
```

---

## Mejoras Implementadas

### Soporte Precio Semestral (31 Enero 2026)

Se agregÃ³ soporte completo para `precio_semestral` en todo el stack:

| Capa | Cambio |
|------|--------|
| **BD** | Columna `precio_semestral NUMERIC(10,2)` + constraint |
| **Modelo** | SELECT, INSERT, UPDATE incluyen el campo |
| **Schema Joi** | ValidaciÃ³n en `crearPlan` y `actualizarPlan` |
| **Checkout** | Usa precio configurado o calcula `precio_mensual Ã— 6` |
| **Frontend** | Campo ya existÃ­a, ahora persiste correctamente |

**Estado actual Plan Pro**: $249/mes, **$1,200/semestral** (configurado manualmente)

### Pantalla Entitlements de Plataforma (31 Enero 2026)

```
Ruta:   /superadmin/entitlements-plataforma
Acceso: nivel >= 100 (SuperAdmin)

Funcionalidades:
- Lista planes de Nexo Team con sus entitlements
- Edita lÃ­mites de usuarios (incluidos, extras, hard limit)
- Edita lÃ­mites de recursos (citas, profesionales, sucursales, etc.)
- Activa/desactiva mÃ³dulos por plan

Beneficios:
1. Formulario de planes limpio (Customer Billing no ve campos de entitlements)
2. Control centralizado para SuperAdmin
3. Escalable: agregar lÃ­mites no afecta otros formularios
```

### Circuit Breaker para MercadoPago

```javascript
// backend/app/utils/circuitBreaker.js
// Protege contra fallos en cascada
Estados: CLOSED â†’ OPEN â†’ HALF_OPEN â†’ CLOSED
maxFailures: 5 errores consecutivos
resetTimeout: 60 segundos
```

### Retry con Backoff Exponencial

```javascript
// backend/app/utils/retryWithBackoff.js
maxRetries: 3
baseDelay: 2000ms
maxDelay: 30000ms
factor: 2 (exponencial)
```

### Prorrateo de Cambio de Plan

```
factor = dÃ­as_restantes / dÃ­as_perÃ­odo
crÃ©dito = precio_actual Ã— factor
cargo = precio_nuevo Ã— factor
diferencia = cargo - crÃ©dito

diferencia > 0 â†’ cobrar inmediato (upgrade)
diferencia < 0 â†’ acumular crÃ©dito (downgrade)
```

---

## Flujo Customer Billing (Preparado, No Activo)

### Caso de Uso: Gimnasio vende membresÃ­as

```
Gimnasio (org 5) â”€â”€â–º Crea planes propios
                          â”‚
                    planes_suscripcion_org (org_id=5)
                    â”œâ”€ "Premium": $500/mes
                    â”œâ”€ "VIP": $1000/mes
                    â””â”€ limites: ???  â† No aplican (Customer Billing)
                          â”‚
                    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                          â”‚
Cliente del gimnasio â”€â”€â–º POST /checkout/iniciar
                          â”‚  es_venta_propia: true
                          â”‚  cliente_id: 100
                          â”‚
                    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
                    â”‚ Strategy: â”‚
                    â”‚ Customer  â”‚
                    â”‚ Billing   â”‚
                    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                          â”‚
            vendorId = 5 (el gimnasio)
            clienteId = 100 (cliente del gimnasio)
                          â”‚
                    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
                    â”‚MercadoPagoâ”‚
                    â”‚ (conector â”‚
                    â”‚ del gym)  â”‚
                    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                          â”‚
                    Pago completado
                          â”‚
                    Â¿QuÃ© pasa con features/limites?
                    â””â”€â–º NADA (no hay cÃ³digo para esto)
```

### Lo que Falta para Customer Billing

1. **Schema de lÃ­mites de servicio**
2. **UI para definir beneficios** (no mÃ³dulos)
3. **VerificaciÃ³n de lÃ­mites del negocio** (ej: visitas/mes)
4. **Acceso del cliente** a beneficios (portal de cliente)

---

## Pendientes

### Alta Prioridad

| Feature | Estado | DescripciÃ³n |
|---------|--------|-------------|
| ~~Pantalla Entitlements SuperAdmin~~ | **âœ… COMPLETADO** | UI para gestionar lÃ­mites/features |
| ~~Job ajustar-preapproval~~ | **âœ… COMPLETADO** | Actualizar monto en MP antes del cobro para seat-based billing |
| Pruebas E2E desde frontend | **PENDIENTE** | Validar flujos completos en navegador |

### Media Prioridad

| Feature | Estado | DescripciÃ³n |
|---------|--------|-------------|
| Customer Billing activo | Arquitectura lista | Endpoint pÃºblico para orgs que venden |
| Notificaciones email | Por implementar | Recibos, alertas de vencimiento |
| Stripe como gateway | Service preparado | Alternativa a MercadoPago |
| Cobro adicional prorateado | Por implementar | Cobrar diferencia cuando agregan usuarios a mitad de mes |

### Baja Prioridad

| Feature | DescripciÃ³n |
|---------|-------------|
| Separar tabla entitlements | Mover `limites`/`features` a tabla dedicada |
| Portal de cliente | UI para clientes de Customer Billing |
| Webhooks salientes | Notificar a orgs sobre eventos de suscripciÃ³n |

---

## Diagramas Mermaid

### Ciclo de Vida de una SuscripciÃ³n

```mermaid
flowchart TB
    subgraph SUPERADMIN["ğŸ”§ SUPERADMIN"]
        SA["/superadmin/entitlements-plataforma"]
        SA --> |"Configura lÃ­mites y mÃ³dulos"| PLANES
    end

    subgraph NEXO["ğŸ¢ NEXO TEAM (org_id=1)"]
        PLANES["ğŸ“‹ Planes Nexo"]
        PLANES --> TRIAL["Plan Trial<br/>$0/mes<br/>3 usuarios (hard)"]
        PLANES --> PRO["Plan Pro<br/>$249/mes<br/>5 usuarios + $49/extra"]
    end

    subgraph REGISTRO["ğŸ“ REGISTRO"]
        REG[Usuario se registra] --> DOG[DogfoodingService]
        DOG --> |"1. Crea cliente en org 1"| CLI[Cliente vinculado]
        DOG --> |"2. Crea suscripciÃ³n"| SUBS[SuscripciÃ³n Trial]
        DOG --> |"3. Activa mÃ³dulos base"| MODS[modulos_activos: core]
    end

    subgraph CHECKOUT["ğŸ’³ CHECKOUT"]
        SEL[Selecciona Plan Pro] --> INIT[POST /checkout/iniciar]
        INIT --> STRAT[PlatformBillingStrategy]
        STRAT --> MP[MercadoPago Preapproval]
        MP --> REDIRECT[Redirect a MP]
        REDIRECT --> PAGO[Usuario paga]
        PAGO --> WEBHOOK[Webhook authorized]
        WEBHOOK --> ACTIVA[actualizarOrgVinculadaAlActivar]
        ACTIVA --> |"Mapea features â†’ mÃ³dulos"| MODACT["modulos_activos:<br/>{agendamiento: true, pos: true}"]
    end

    subgraph USO["ğŸ“Š USO DIARIO"]
        CREAR[Admin crea usuario] --> LIMITE[LimitesHelper.verificarLimite]
        LIMITE --> CHECK{Â¿Excede lÃ­mite?}
        CHECK --> |"< incluidos"| OK[âœ… Permitido]
        CHECK --> |">= incluidos + hay precio_extra"| EXTRA[âœ… Permitido<br/>Se cobra extra]
        CHECK --> |">= max_hard"| BLOCK[âŒ Bloqueado<br/>Error 403]
    end

    subgraph COBRO["ğŸ’° COBRO MENSUAL"]
        JOB1["Job 23:55<br/>registrar-uso-usuarios"] --> |"Guarda snapshot diario"| TABLA[(uso_usuarios_org)]
        TABLA --> JOB2["Job 06:00<br/>procesar-cobros"]
        JOB2 --> CALC["MAX usuarios perÃ­odo: 8<br/>Incluidos: 5<br/>Extra: 3 Ã— $49 = $147"]
        CALC --> TOTAL["TOTAL: $249 + $147 = $396"]
    end

    NEXO --> REGISTRO
    REGISTRO --> CHECKOUT
    CHECKOUT --> USO
    USO --> COBRO
```

### Estados de SuscripciÃ³n

```mermaid
stateDiagram-v2
    [*] --> trial: Usuario se registra

    trial --> pendiente_pago: Inicia checkout
    trial --> suspendida: Trial expira sin pago

    pendiente_pago --> activa: Pago exitoso
    pendiente_pago --> trial: Cancela checkout

    activa --> pausada: Usuario pausa
    activa --> grace_period: Fallo en cobro
    activa --> cancelada: Usuario cancela

    pausada --> activa: Usuario reactiva
    pausada --> cancelada: No reactiva en 30 dÃ­as

    grace_period --> activa: Paga pendiente
    grace_period --> suspendida: 7 dÃ­as sin pago

    suspendida --> activa: Paga y reactiva
    cancelada --> [*]

    note right of trial: âœ… Acceso completo
    note right of activa: âœ… Acceso completo
    note right of pendiente_pago: âœ… Acceso completo
    note right of grace_period: âš ï¸ Solo lectura
    note right of pausada: âŒ Bloqueado
    note right of suspendida: âŒ Bloqueado
    note right of cancelada: âŒ Bloqueado
```

### Arquitectura Dogfooding

```mermaid
flowchart LR
    subgraph NEXO["NEXO TEAM (org_id=1)"]
        direction TB
        P1[Planes Nexo]
        C1[Conectores MP]
        S1[Suscripciones]
    end

    subgraph ORG2["OrganizaciÃ³n 2"]
        direction TB
        U2[Usuarios]
        M2[MÃ³dulos activos]
        L2[LÃ­mites aplicados]
    end

    subgraph ORG3["OrganizaciÃ³n 3"]
        direction TB
        U3[Usuarios]
        M3[MÃ³dulos activos]
        L3[LÃ­mites aplicados]
    end

    NEXO -->|"Platform Billing<br/>Cobra y controla"| ORG2
    NEXO -->|"Platform Billing<br/>Cobra y controla"| ORG3

    style NEXO fill:#e1f5fe
    style ORG2 fill:#f3e5f5
    style ORG3 fill:#f3e5f5
```

### Flujo de VerificaciÃ³n de LÃ­mites

```mermaid
flowchart TD
    A[Admin intenta crear usuario] --> B[LimitesHelper.verificarLimiteOLanzar]
    B --> C[RLSContextManager.withBypass]
    C --> D["Busca suscripciÃ³n donde<br/>cliente.org_vinculada_id = org_actual"]
    D --> E[Obtiene plan con lÃ­mites]
    E --> F{usuarios_actuales < usuarios_incluidos?}

    F -->|SÃ­| G[âœ… Crear usuario]
    F -->|No| H{hay precio_usuario_adicional?}

    H -->|SÃ­| I{usuarios < max_usuarios_hard?}
    H -->|No| J[âŒ Error: LÃ­mite alcanzado<br/>Cambiar de plan]

    I -->|SÃ­ o max=null| K[âœ… Crear usuario<br/>Se cobrarÃ¡ extra]
    I -->|No| L[âŒ Error: LÃ­mite mÃ¡ximo<br/>alcanzado]

    style G fill:#c8e6c9
    style K fill:#c8e6c9
    style J fill:#ffcdd2
    style L fill:#ffcdd2
```

### Seat-Based Billing: CÃ¡lculo Mensual

```mermaid
flowchart LR
    subgraph TRACKING["ğŸ“Š Tracking Diario (23:55)"]
        D1["Ene 01: 5 usuarios"]
        D2["Ene 05: 6 usuarios"]
        D3["Ene 15: 8 usuarios"]
        D4["Ene 20: 7 usuarios"]
        D5["Ene 31: 7 usuarios"]
    end

    subgraph CALCULO["ğŸ’° CÃ¡lculo (06:00)"]
        MAX["MAX = 8 usuarios"]
        INC["Incluidos = 5"]
        EXT["Extra = 8 - 5 = 3"]
        PRECIO["3 Ã— $49 = $147"]
    end

    subgraph COBRO["ğŸ’³ Cobro"]
        BASE["Base: $249"]
        AJUSTE["Ajuste: $147"]
        TOTAL["TOTAL: $396"]
    end

    TRACKING --> MAX
    MAX --> EXT
    INC --> EXT
    EXT --> PRECIO
    PRECIO --> AJUSTE
    BASE --> TOTAL
    AJUSTE --> TOTAL
```

### CuÃ¡ndo Crear Plan Nuevo vs Seat-Based

```mermaid
flowchart TD
    Q[Cliente quiere mÃ¡s capacidad] --> T{Â¿QuÃ© necesita?}

    T -->|MÃ¡s usuarios| U{Â¿Quiere precio fijo?}
    U -->|No, paga por uso| SB[âœ… Seat-Based Billing<br/>Plan Pro + $49/extra]
    U -->|SÃ­, precio fijo| NP1[ğŸ†• Crear Plan Enterprise<br/>50 usuarios por $999]

    T -->|Diferentes mÃ³dulos| NP2[ğŸ†• Crear Plan especÃ­fico<br/>Ej: Solo POS]

    T -->|Descuento volumen| NP3[ğŸ†• Crear Plan Enterprise<br/>Usuarios ilimitados]

    T -->|MÃ¡s sucursales| SB2[âœ… Ajustar lÃ­mites<br/>en Entitlements]

    style SB fill:#c8e6c9
    style SB2 fill:#c8e6c9
    style NP1 fill:#fff9c4
    style NP2 fill:#fff9c4
    style NP3 fill:#fff9c4
```

### Flujo de Cobro MercadoPago (Preapproval)

```mermaid
sequenceDiagram
    participant ORG as OrganizaciÃ³n
    participant NEXO as Nexo Backend
    participant MP as MercadoPago
    participant WH as Webhook Handler

    Note over ORG,MP: ğŸ”µ ACTIVACIÃ“N INICIAL

    ORG->>NEXO: 1. Selecciona Plan Pro ($249)
    NEXO->>MP: 2. POST /preapproval
    MP-->>ORG: 3. Redirect checkout
    ORG->>MP: 4. Autoriza pago
    MP->>WH: 5. subscription_preapproval (authorized)
    WH->>NEXO: 6. Activar suscripciÃ³n

    Note over ORG,MP: ğŸŸ¢ MES 2: COBRO AUTOMÃTICO

    MP->>MP: MP procesa cobro ($249)
    MP->>WH: subscription_authorized_payment
    WH->>NEXO: Registrar pago
    NEXO-->>ORG: Email confirmaciÃ³n

    Note over ORG,MP: ğŸŸ¡ MES 3: ORG AGREGÃ“ USUARIOS

    rect rgb(255, 245, 200)
        Note right of NEXO: DÃ­a 28: Job ajuste
        NEXO->>NEXO: MAX usuarios = 8
        NEXO->>NEXO: Extra: (8-5) Ã— $49 = $147
        NEXO->>MP: PUT /preapproval â†’ $396
    end

    MP->>MP: MP procesa cobro ($396)
    MP->>WH: subscription_authorized_payment
    WH->>NEXO: Registrar pago $396

    Note over ORG,MP: ğŸ”´ CANCELACIÃ“N

    ORG->>MP: Cancela desde MP
    MP->>WH: subscription_preapproval (cancelled)
    WH->>NEXO: Cancelar suscripciÃ³n
```

### Comparativa: QuiÃ©n Procesa el Cobro

```mermaid
flowchart TB
    subgraph MP_AUTO["ğŸŸ¢ MercadoPago Preapproval"]
        direction TB
        MP1[Preapproval creado] --> MP2[MP agenda cobros]
        MP2 --> MP3[MP procesa automÃ¡ticamente]
        MP3 --> MP4[Webhook nos notifica]
        MP4 --> MP5[Registramos pago]
    end

    subgraph STRIPE_MANUAL["ğŸ”µ Stripe / Manual"]
        direction TB
        ST1[SuscripciÃ³n creada] --> ST2[Job diario 06:00]
        ST2 --> ST3[fecha_proximo_cobro = hoy?]
        ST3 --> ST4[Nexo inicia cobro]
        ST4 --> ST5[Stripe procesa]
        ST5 --> ST6[Webhook confirma]
    end

    subgraph JOB_AJUSTE["ğŸŸ¡ Job Ajuste Preapproval"]
        direction TB
        AJ1[DÃ­a 28 mes] --> AJ2[Calcular usuarios extra]
        AJ2 --> AJ3{Â¿CambiÃ³ monto?}
        AJ3 -->|SÃ­| AJ4[PUT /preapproval]
        AJ3 -->|No| AJ5[Sin cambios]
        AJ4 --> AJ6[MP cobra nuevo monto]
    end

    style MP_AUTO fill:#c8e6c9
    style STRIPE_MANUAL fill:#bbdefb
    style JOB_AJUSTE fill:#fff9c4
```

---

## Credenciales de Prueba

```
# Cuenta Comprador MercadoPago (Sandbox)
Email: test_user_2716725750605322996@testuser.com
Password: UCgyF4L44D

# Usuario Admin Org 2
Email: arellanestorillo@gmail.com
Password: Enrique23

# SuperAdmin
Email: arellanestorillo@yahoo.com
Password: Enrique23
```

---

**Estado**: Platform Billing âœ… Funcional | Customer Billing ğŸš§ Preparado | Entitlements UI âœ… Implementado | Seat-Based Billing âœ… Funcional | Multi-Periodo (mensual/trim/semestral/anual) âœ…
