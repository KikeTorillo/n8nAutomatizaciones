meta {
  name: 06 - Test Emails √önicos Por Organizaci√≥n
  type: http
  seq: 6
}

post {
  url: {{baseUrl}}/api/v1/clientes
  body: json
  auth: bearer
}

auth:bearer {
  token: {{managerBarberiaToken}}
}

headers {
  Content-Type: application/json
}

body:json {
  {
    "nombre": "Andr√©s",
    "apellidos": "Cliente Duplicado",
    "email": "andres.gomez@email.com",
    "telefono": "+573509999999",
    "fecha_nacimiento": "1990-01-01",
    "preferencias": {
      "servicios_frecuentes": ["corte_clasico"]
    }
  }
}

tests {
  test("Should return validation error for duplicate email", function() {
    expect(res.getStatus()).to.equal(400);
  });

  test("Response should contain success false", function() {
    const body = res.getBody();
    expect(body).to.have.property('success', false);
  });

  test("Should validate email √∫nico por organizaci√≥n", function() {
    const body = res.getBody();
    expect(body).to.have.property('error');

    const errorMsg = body.error.toLowerCase();
    const hasEmailError = errorMsg.includes('email') ||
                         errorMsg.includes('√∫nico') ||
                         errorMsg.includes('existe') ||
                         errorMsg.includes('duplicado');

    expect(hasEmailError).to.be.true("Error debe indicar email duplicado");
  });

  test("Sistema de unicidad por organizaci√≥n funcionando", function() {
    const body = res.getBody();
    console.log("üìß VALIDACI√ìN EMAILS √öNICOS POR ORGANIZACI√ìN:");
    console.log("  ‚Ä¢ Intento: Crear cliente con email existente en barber√≠a");
    console.log(`  ‚Ä¢ Email: andres.gomez@email.com`);
    console.log("  ‚Ä¢ Resultado: ‚ùå RECHAZADO correctamente");
    console.log(`  ‚Ä¢ Error: ${body.error}`);

    console.log("\nüîí REGLAS DE UNICIDAD MULTI-TENANT:");
    console.log("  ‚Ä¢ ‚úÖ Email debe ser √∫nico DENTRO de cada organizaci√≥n");
    console.log("  ‚Ä¢ ‚úÖ Mismo email PUEDE existir en diferentes organizaciones");
    console.log("  ‚Ä¢ ‚úÖ Tel√©fono debe ser √∫nico DENTRO de cada organizaci√≥n");
    console.log("  ‚Ä¢ ‚úÖ Sistema previene duplicados en misma organizaci√≥n");
  });
}